<!DOCTYPE html>
<html lang="zh-CN">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/k-focusprogram.gitee.io/img/Mr.Kong.jpg">
  <link rel="icon" type="image/png" href="/k-focusprogram.gitee.io/img/Mr.Kong.jpg">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="May you experience the pain and happiness in your life">
  <meta name="author" content="Mr.Kong">
  <meta name="keywords" content="">
  <title>Lvs+Keepalived+Nginx+FastDFS分布式文件系统高可用集群搭建 - Mr.Kong Blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/k-focusprogram.gitee.io/lib/hint/hint.min.css" />

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/dark.min.css" />
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_yg9cfy8wd6.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/k-focusprogram.gitee.io/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/k-focusprogram.gitee.io/js/utils.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/k-focusprogram.gitee.io/">&nbsp;<strong>Mr.Kong</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/k-focusprogram.gitee.io/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/k-focusprogram.gitee.io/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/k-focusprogram.gitee.io/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/k-focusprogram.gitee.io/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/k-focusprogram.gitee.io/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/k-focusprogram.gitee.io/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-bookmark-fill"></i>
                开源地址
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="https://gitee.com/FocusProgram/" target="_blank" rel="noopener">
                    
                    Gitee
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://github.com/FocusProgram/" target="_blank" rel="noopener">
                    
                    GitHub
                  </a>
                
              </div>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/k-focusprogram.gitee.io/img/neight.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-07-11 16:40">
      2020年7月11日 下午
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      5.4k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      86
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
              <p class="note note-info">
                
                  本文最后更新于：2 天前
                
              </p>
            
            <article class="markdown-body">
              <p>高可用文件服务器架构设计图</p>
<hr>
<p><img src="https://image.focusprogram.top/FastDFS.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt=""></p>
<p>所需服务器配置</p>
<hr>
<p><img src="https://image.focusprogram.top/20191127143513.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt=""></p>
<blockquote>
<p>==192.168.80.128==       和 ==192.168.80.129==两台服务器上搭建Nginx+Keepalived</p>
</blockquote>
<hr>
<p>基础软件安装</p>
<div class="hljs"><pre><code class="hljs cmake">$ yum <span class="hljs-keyword">install</span> gcc openssl-devel libnl libnl-devel libnfnetlink-devel net-tools vim wget lrzsz lsof -y</code></pre></div>

<blockquote>
<p>Keepalived源码包安装</p>
</blockquote>
<p>下载安装Keepalived</p>
<div class="hljs"><pre><code class="hljs powershell"><span class="hljs-variable">$</span> mkdir /<span class="hljs-keyword">data</span> &amp;&amp; cd /<span class="hljs-keyword">data</span>

<span class="hljs-variable">$</span> wget https://www.keepalived.org/software/keepalived<span class="hljs-literal">-2</span>.<span class="hljs-number">0.19</span>.tar.gz

<span class="hljs-variable">$</span> tar <span class="hljs-literal">-zxvf</span> keepalived<span class="hljs-literal">-2</span>.<span class="hljs-number">0.19</span>.tar.gz

<span class="hljs-variable">$</span> cd /keepalived<span class="hljs-literal">-2</span>.<span class="hljs-number">0.19</span>

<span class="hljs-variable">$</span> ./configure

<span class="hljs-variable">$</span> make &amp;&amp; make install</code></pre></div>

<p>keepalived配置</p>
<div class="hljs"><pre><code class="hljs awk">$ mkdir <span class="hljs-regexp">/etc/</span>keepalived

$ cp <span class="hljs-regexp">/data/</span>keepalived-<span class="hljs-number">2.0</span>.<span class="hljs-number">19</span><span class="hljs-regexp">/keepalived/</span>etc<span class="hljs-regexp">/keepalived/</span>keepalived.conf <span class="hljs-regexp">/etc/</span>keepalived<span class="hljs-regexp">/</span></code></pre></div>

<p>开机启动项</p>
<div class="hljs"><pre><code class="hljs groovy">$ cp <span class="hljs-regexp">/data/</span>keepalived<span class="hljs-number">-2.0</span><span class="hljs-number">.19</span><span class="hljs-regexp">/keepalived/</span>etc<span class="hljs-regexp">/init.d/</span>keepalived <span class="hljs-regexp">/etc/</span>rc.d<span class="hljs-regexp">/init.d/</span>

$ cp <span class="hljs-regexp">/data/</span>keepalived<span class="hljs-number">-2.0</span><span class="hljs-number">.19</span><span class="hljs-regexp">/keepalived/</span>etc<span class="hljs-regexp">/sysconfig/</span>keepalived <span class="hljs-regexp">/etc/</span>sysconfig/

$ cp <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/sbin/</span>keepalived <span class="hljs-regexp">/usr/</span>sbin/

$ chkconfig –add keepalived

$ chkconfig keepalived on</code></pre></div>

<blockquote>
<p>Keepalived从yum源安装</p>
</blockquote>
<div class="hljs"><pre><code class="hljs cmake">$ yum <span class="hljs-keyword">install</span> -y keepalived</code></pre></div>

<blockquote>
<p>服务命令（启动、重启、关闭）</p>
</blockquote>
<div class="hljs"><pre><code class="hljs dts">$ <span class="hljs-meta-keyword">/etc/</span>init.d/keepalived start 启动
 
$ <span class="hljs-meta-keyword">/etc/</span>init.d/keepalived restart 重启

$ <span class="hljs-meta-keyword">/etc/</span>init.d/keepalived stop 停止</code></pre></div>

<p>安装ipvsadm（用于查看lvs转发及代理情况的工具）</p>
<div class="hljs"><pre><code class="hljs cmake">$ yum <span class="hljs-keyword">install</span> ipvsadm -y</code></pre></div>

<p>查看统计</p>
<div class="hljs"><pre><code class="hljs elixir"><span class="hljs-comment">#查看当前配置的虚拟服务和各个RS的权重</span>
<span class="hljs-variable">$ </span>ipvsadm -Ln
<span class="hljs-comment">#查看当前ipvs模块中记录的连接（可用于观察转发情况）</span>
<span class="hljs-variable">$ </span>ipvsadm -lnc
<span class="hljs-comment">#查看ipvs模块的转发情况统计</span>
<span class="hljs-variable">$ </span>ipvsadm -Ln --stats | --rate</code></pre></div>

<p>lvs超时配置</p>
<div class="hljs"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">查看lvs的超时时间</span>
<span class="hljs-meta">$</span><span class="bash"> ipvsadm -L --timeout</span>

<span class="hljs-meta">#</span><span class="bash">优化连接超时时间</span>
<span class="hljs-meta">$</span><span class="bash"> ipvsadm --<span class="hljs-built_in">set</span> 1 10 300</span></code></pre></div>
<p>lvs监控真实服务测试</p>
<div class="hljs"><pre><code class="hljs elixir"><span class="hljs-comment">#查看最新的虚拟ip对应的RealServer的情况</span>
<span class="hljs-variable">$ </span>ipvsadm -l</code></pre></div>

<p>配置Keepalived</p>
<blockquote>
<p>配置Master</p>
</blockquote>
<div class="hljs"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> <span class="hljs-built_in">cd</span> /etc/keepalived</span>

<span class="hljs-meta">#</span><span class="bash">备份默认的keepalived配置</span>
<span class="hljs-meta">$</span><span class="bash"> mv keepalived.conf keepalived-back.conf</span>

<span class="hljs-meta">$</span><span class="bash"> vim keepalived.conf</span></code></pre></div>

<p>添加以下配置:</p>
<div class="hljs"><pre><code class="hljs angelscript">global_defs &#123;
   # 这里配置只能发送邮件到本机
   notification_email &#123;
         <span class="hljs-symbol">root@</span>localhost
   &#125;
   notification_email_from <span class="hljs-symbol">root@</span>localhost
   smtp_server <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
   smtp_connection_timeout <span class="hljs-number">30</span>
   router_id LVS_DEVEL  # 设置lvs的id，在一个网络内应该是唯一的
&#125;
vrrp_instance VI_1 &#123;
    state MASTER   #指定Keepalived的角色，MASTER为主，BACKUP为备 记得大写
    <span class="hljs-keyword">interface</span> <span class="hljs-symbol">ens33</span>  #网卡<span class="hljs-symbol">id</span> 不同的电脑网卡<span class="hljs-symbol">id</span>会有区别 可以使用:<span class="hljs-symbol">ip</span> <span class="hljs-symbol">a</span>查看
    <span class="hljs-symbol">virtual_router_id</span> <span class="hljs-symbol">51</span>  #虚拟路由编号，主备要一致
    <span class="hljs-symbol">priority</span> <span class="hljs-symbol">100</span>  #定义优先级，数字越大，优先级越高，主<span class="hljs-symbol">DR</span>必须大于备用<span class="hljs-symbol">DR</span>
    <span class="hljs-symbol">advert_int</span> <span class="hljs-symbol">1</span>  #检查间隔，默认为<span class="hljs-symbol">1s</span>
    <span class="hljs-symbol">authentication</span> &#123;   #这里配置的密码最多为<span class="hljs-number">8</span>位，主备要一致，否则无法正常通讯
        auth_type PASS
        auth_pass <span class="hljs-number">159357</span>
    &#125;
    virtual_ipaddress &#123;
        <span class="hljs-number">192.168</span><span class="hljs-number">.80</span><span class="hljs-number">.80</span>  #定义虚拟IP(VIP)为<span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.200</span>，可多设，每行一个
    &#125;
&#125;
# 定义对外提供服务的LVS的VIP以及port
virtual_server <span class="hljs-number">192.168</span><span class="hljs-number">.80</span><span class="hljs-number">.80</span> <span class="hljs-number">80</span> &#123;
    delay_loop <span class="hljs-number">6</span> # 设置健康检查时间，单位是秒
    lb_algo rr # 设置负载调度的算法为wlc
    lb_kind DR # 设置LVS实现负载的机制，有NAT、TUN、DR三个模式
    nat_mask <span class="hljs-number">255.255</span><span class="hljs-number">.255</span><span class="hljs-number">.0</span>
    persistence_timeout <span class="hljs-number">0</span>
    protocol TCP
    real_server <span class="hljs-number">192.168</span><span class="hljs-number">.80</span><span class="hljs-number">.128</span> <span class="hljs-number">80</span> &#123;  # 指定real server1的IP地址
        weight <span class="hljs-number">3</span>   # 配置节点权值，数字越大权重越高
        TCP_CHECK &#123;
        connect_timeout <span class="hljs-number">10</span>
        nb_get_retry <span class="hljs-number">3</span>
        delay_before_retry <span class="hljs-number">3</span>
        connect_port <span class="hljs-number">80</span>
        &#125;
    &#125;
    real_server <span class="hljs-number">192.168</span><span class="hljs-number">.80</span><span class="hljs-number">.129</span> <span class="hljs-number">80</span> &#123;  # 指定real server2的IP地址
        weight <span class="hljs-number">3</span>  # 配置节点权值，数字越大权重越高
        TCP_CHECK &#123;
        connect_timeout <span class="hljs-number">10</span>
        nb_get_retry <span class="hljs-number">3</span>
        delay_before_retry <span class="hljs-number">3</span>
        connect_port <span class="hljs-number">80</span>
        &#125;
     &#125;
&#125;</code></pre></div>

<blockquote>
<p>配置Backup</p>
</blockquote>
<div class="hljs"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> <span class="hljs-built_in">cd</span> /etc/keepalived</span>

<span class="hljs-meta">#</span><span class="bash">备份默认的keepalived配置</span>
<span class="hljs-meta">$</span><span class="bash"> mv keepalived.conf keepalived-back.conf</span>

<span class="hljs-meta">$</span><span class="bash"> vim keepalived.conf</span></code></pre></div>

<p>添加以下配置:</p>
<div class="hljs"><pre><code class="hljs angelscript">global_defs &#123;
   # 这里配置只能发送邮件到本机
   notification_email &#123;
         <span class="hljs-symbol">root@</span>localhost
   &#125;
   notification_email_from <span class="hljs-symbol">root@</span>localhost
   smtp_server <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
   smtp_connection_timeout <span class="hljs-number">30</span>
   router_id LVS_DEVEL  # 设置lvs的id，在一个网络内应该是唯一的
&#125;
vrrp_instance VI_1 &#123;
    state BACKUP   #指定Keepalived的角色，MASTER为主，BACKUP为备 记得大写
    <span class="hljs-keyword">interface</span> <span class="hljs-symbol">ens33</span>  #网卡<span class="hljs-symbol">id</span> 不同的电脑网卡<span class="hljs-symbol">id</span>会有区别 可以使用:<span class="hljs-symbol">ip</span> <span class="hljs-symbol">a</span>查看
    <span class="hljs-symbol">nopreempt</span> #不与主机<span class="hljs-symbol">MASTER</span>抢占<span class="hljs-symbol">VIP</span>资源
    <span class="hljs-symbol">virtual_router_id</span> <span class="hljs-symbol">51</span>  #虚拟路由编号，主备要一致
    <span class="hljs-symbol">priority</span> <span class="hljs-symbol">90</span> #定义优先级，数字越大，优先级越高，主<span class="hljs-symbol">DR</span>必须大于备用<span class="hljs-symbol">DR</span>
    <span class="hljs-symbol">advert_int</span> <span class="hljs-symbol">1</span>  #检查间隔，默认为<span class="hljs-symbol">1s</span>
    <span class="hljs-symbol">authentication</span> &#123;   #这里配置的密码最多为<span class="hljs-number">8</span>位，主备要一致，否则无法正常通讯
        auth_type PASS
        auth_pass <span class="hljs-number">159357</span>
    &#125;
    virtual_ipaddress &#123;
        <span class="hljs-number">192.168</span><span class="hljs-number">.80</span><span class="hljs-number">.80</span>  #定义虚拟IP(VIP)为<span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.200</span>，可多设，每行一个
    &#125;
&#125;
# 定义对外提供服务的LVS的VIP以及port
virtual_server <span class="hljs-number">192.168</span><span class="hljs-number">.80</span><span class="hljs-number">.80</span> <span class="hljs-number">80</span> &#123;
    delay_loop <span class="hljs-number">6</span> # 设置健康检查时间，单位是秒
    lb_algo rr # 设置负载调度的算法为wlc
    lb_kind DR # 设置LVS实现负载的机制，有NAT、TUN、DR三个模式
    nat_mask <span class="hljs-number">255.255</span><span class="hljs-number">.255</span><span class="hljs-number">.0</span>
    persistence_timeout <span class="hljs-number">0</span>
    protocol TCP
    real_server <span class="hljs-number">192.168</span><span class="hljs-number">.80</span><span class="hljs-number">.128</span> <span class="hljs-number">80</span> &#123;  # 指定real server1的IP地址
        weight <span class="hljs-number">3</span>   # 配置节点权值，数字越大权重越高
        TCP_CHECK &#123;
        connect_timeout <span class="hljs-number">10</span>
        nb_get_retry <span class="hljs-number">3</span>
        delay_before_retry <span class="hljs-number">3</span>
        connect_port <span class="hljs-number">80</span>
        &#125;
    &#125;
    real_server <span class="hljs-number">192.168</span><span class="hljs-number">.80</span><span class="hljs-number">.129</span> <span class="hljs-number">80</span> &#123;  # 指定real server2的IP地址
        weight <span class="hljs-number">3</span>  # 配置节点权值，数字越大权重越高
        TCP_CHECK &#123;
        connect_timeout <span class="hljs-number">10</span>
        nb_get_retry <span class="hljs-number">3</span>
        delay_before_retry <span class="hljs-number">3</span>
        connect_port <span class="hljs-number">80</span>
        &#125;
     &#125;
&#125;</code></pre></div>

<p>配置Keepalived出现问题时发送邮件</p>
<p>编写脚本sendmail.pl放在/etc/keepalived 中</p>
<div class="hljs"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> <span class="hljs-built_in">cd</span> /etc/keepalived</span>

<span class="hljs-meta">$</span><span class="bash"> vim sendmail.pl</span>

<span class="hljs-meta">$</span><span class="bash"> chmod 755 sendmail.pl</span></code></pre></div>

<p>添加如下内容：</p>
<div class="hljs"><pre><code class="hljs clean">#!/usr/bin/perl -w  
use Net::SMTP_auth;  
use strict;  
my $mailhost = <span class="hljs-string">'smtp.163.com'</span>;  
my $mailfrom = <span class="hljs-string">'email@163.com'</span>;  
my @mailto   = (<span class="hljs-string">'email@163.com'</span>);  
my $subject  = <span class="hljs-string">'keepalived up on backup'</span>;  
my $text = <span class="hljs-string">"Keepalived服务器宕机！"</span>;    
my $user   = <span class="hljs-string">'email@163.com'</span>;  
my $passwd = <span class="hljs-string">'*******'</span>;   #注意是要填写客户端授权的密码
&amp;SendMail();  
##############################  
# Send notice mail  
##############################  
sub SendMail() &#123;  
    my $smtp = Net::SMTP_auth-&gt;new( $mailhost, Timeout =&gt; <span class="hljs-number">120</span>, Debug =&gt; <span class="hljs-number">1</span> )  
      or die <span class="hljs-string">"Error.\n"</span>;  
    $smtp-&gt;auth( <span class="hljs-string">'LOGIN'</span>, $user, $passwd );  
    foreach my $mailto (@mailto) &#123;  
        $smtp-&gt;mail($mailfrom);  
        $smtp-&gt;to($mailto);  
        $smtp-&gt;data();  
        $smtp-&gt;datasend(<span class="hljs-string">"To: $mailto\n"</span>);  
        $smtp-&gt;datasend(<span class="hljs-string">"From:$mailfrom\n"</span>);  
        $smtp-&gt;datasend(<span class="hljs-string">"Subject: $subject\n"</span>);  
        $smtp-&gt;datasend(<span class="hljs-string">"\n"</span>);  
        $smtp-&gt;datasend(<span class="hljs-string">"$text\n\n"</span>);   
        $smtp-&gt;dataend();  
    &#125;  
    $smtp-&gt;quit;  
&#125;</code></pre></div>

<p>Keepalived配置文件修改内容，注：我把脚本放到了与配置文件同级目录下，添加一段：</p>
<div class="hljs"><pre><code class="hljs angelscript">global_defs &#123;
   # 这里配置只能发送邮件到本机
   notification_email &#123;
         <span class="hljs-symbol">root@</span>localhost
   &#125;
   notification_email_from <span class="hljs-symbol">root@</span>localhost
   smtp_server <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
   smtp_connection_timeout <span class="hljs-number">30</span>
   router_id LVS_DEVEL  # 设置lvs的id，在一个网络内应该是唯一的
&#125;

vrrp_script chk_nginx &#123;
    script <span class="hljs-string">"/etc/keepalived/ck_ng.sh"</span>
    <span class="hljs-built_in">int</span>erval <span class="hljs-number">2</span>
    weight <span class="hljs-number">-5</span>
    fall <span class="hljs-number">3</span>
    rise <span class="hljs-number">2</span>
&#125;

vrrp_sync_group VG_1 &#123;
   group &#123;
      VI_1
&#125;
 #节点变为master时执行
 notify_master /etc/keepalived/sendmail.pl
&#125;

vrrp_instance VI_1 &#123;
    state MASTER   #指定Keepalived的角色，MASTER为主，BACKUP为备 记得大写
    <span class="hljs-keyword">interface</span> <span class="hljs-symbol">ens33</span>  #网卡<span class="hljs-symbol">id</span> 不同的电脑网卡<span class="hljs-symbol">id</span>会有区别 可以使用:<span class="hljs-symbol">ip</span> <span class="hljs-symbol">a</span>查看
    <span class="hljs-symbol">virtual_router_id</span> <span class="hljs-symbol">51</span>  #虚拟路由编号，主备要一致
    <span class="hljs-symbol">priority</span> <span class="hljs-symbol">100</span>  #定义优先级，数字越大，优先级越高，主<span class="hljs-symbol">DR</span>必须大于备用<span class="hljs-symbol">DR</span>
    <span class="hljs-symbol">advert_int</span> <span class="hljs-symbol">1</span>  #检查间隔，默认为<span class="hljs-symbol">1s</span>
    <span class="hljs-symbol">authentication</span> &#123;   #这里配置的密码最多为<span class="hljs-number">8</span>位，主备要一致，否则无法正常通讯
        auth_type PASS
        auth_pass <span class="hljs-number">159357</span>
    &#125;
    virtual_ipaddress &#123;
        <span class="hljs-number">192.168</span><span class="hljs-number">.80</span><span class="hljs-number">.80</span>  #定义虚拟IP(VIP)为<span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.200</span>，可多设，每行一个
    &#125;
&#125;
# 定义对外提供服务的LVS的VIP以及port
virtual_server <span class="hljs-number">192.168</span><span class="hljs-number">.80</span><span class="hljs-number">.80</span> <span class="hljs-number">80</span> &#123;
    delay_loop <span class="hljs-number">6</span> # 设置健康检查时间，单位是秒
    lb_algo rr # 设置负载调度的算法为wlc
    lb_kind DR # 设置LVS实现负载的机制，有NAT、TUN、DR三个模式
    nat_mask <span class="hljs-number">255.255</span><span class="hljs-number">.255</span><span class="hljs-number">.0</span>
    persistence_timeout <span class="hljs-number">0</span>
    protocol TCP
    real_server <span class="hljs-number">192.168</span><span class="hljs-number">.80</span><span class="hljs-number">.128</span> <span class="hljs-number">80</span> &#123;  # 指定real server1的IP地址
        weight <span class="hljs-number">3</span>   # 配置节点权值，数字越大权重越高
        TCP_CHECK &#123;
        connect_timeout <span class="hljs-number">10</span>
        nb_get_retry <span class="hljs-number">3</span>
        delay_before_retry <span class="hljs-number">3</span>
        connect_port <span class="hljs-number">80</span>
        &#125;
    &#125;
    real_server <span class="hljs-number">192.168</span><span class="hljs-number">.80</span><span class="hljs-number">.129</span> <span class="hljs-number">80</span> &#123;  # 指定real server2的IP地址
        weight <span class="hljs-number">3</span>  # 配置节点权值，数字越大权重越高
        TCP_CHECK &#123;
        connect_timeout <span class="hljs-number">10</span>
        nb_get_retry <span class="hljs-number">3</span>
        delay_before_retry <span class="hljs-number">3</span>
        connect_port <span class="hljs-number">80</span>
        &#125;
     &#125;
&#125;</code></pre></div>

<p>可进入该脚本目录，直接执行脚本，看看是否发送邮件成功；若失败，安装Net::SMTP_auth模块 ，安装方法：</p>
<div class="hljs"><pre><code class="hljs vim">$ yum -<span class="hljs-keyword">y</span> install <span class="hljs-keyword">perl</span>-CPAN 

$ <span class="hljs-keyword">perl</span> -MCPAN -<span class="hljs-keyword">e</span> <span class="hljs-keyword">shell</span>

capn &gt; install Ne<span class="hljs-variable">t:</span>:SMTP_auth</code></pre></div>

<blockquote>
<p>Nginx源码包安装</p>
</blockquote>
<p>安装c++依赖库</p>
<div class="hljs"><pre><code class="hljs brainfuck"><span class="hljs-comment">$</span> <span class="hljs-comment">yum</span> <span class="hljs-comment">install</span> <span class="hljs-literal">-</span><span class="hljs-comment">y</span> <span class="hljs-comment">gcc</span><span class="hljs-literal">-</span><span class="hljs-comment">c</span>++</code></pre></div>

<p>下载依赖文件压缩包</p>
<div class="hljs"><pre><code class="hljs gams"><span class="hljs-symbol">$</span> cd /data

<span class="hljs-symbol">$</span> wget http:<span class="hljs-comment">//nginx.org/download/nginx-1.16.1.tar.gz</span>

<span class="hljs-symbol">$</span> wget http:<span class="hljs-comment">//www.openssl.org/source/openssl-1.1.0f.tar.gz</span>

<span class="hljs-symbol">$</span> wget http:<span class="hljs-comment">//zlib.NET/zlib-1.2.11.tar.gz</span>

<span class="hljs-symbol">$</span> wget ftp:<span class="hljs-comment">//ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.40.tar.gz</span></code></pre></div>

<p>解压资源</p>
<div class="hljs"><pre><code class="hljs angelscript">$ cd /data

$ tar -xf zlib<span class="hljs-number">-1.2</span><span class="hljs-number">.11</span>.tar.gz

$ tar -xf openssl<span class="hljs-number">-1.1</span><span class="hljs-number">.0f</span>.tar.gz

$ tar -xf pcre<span class="hljs-number">-8.40</span>.tar.gz

$ tar -xf nginx<span class="hljs-number">-1.12</span><span class="hljs-number">.1</span>.tar.gz</code></pre></div>

<p>设置权限</p>
<div class="hljs"><pre><code class="hljs haskell">$ chown -<span class="hljs-type">R</span> root:root ./<span class="hljs-class"><span class="hljs-keyword">data</span></span></code></pre></div>

<blockquote>
<p>编译安装</p>
</blockquote>
<p>安装zlib</p>
<div class="hljs"><pre><code class="hljs powershell"><span class="hljs-variable">$</span> cd /<span class="hljs-keyword">data</span>/zlib<span class="hljs-literal">-1</span>.<span class="hljs-number">2.11</span>/

<span class="hljs-variable">$</span> ./configure

<span class="hljs-variable">$</span> make &amp;&amp; make install</code></pre></div>

<p>安装openssl(用于配置ssl证书)</p>
<div class="hljs"><pre><code class="hljs routeros">$ cd /data/openssl-1.1.0f/

$./config

$ make &amp;&amp; make install</code></pre></div>

<p>安装pcre</p>
<div class="hljs"><pre><code class="hljs powershell"><span class="hljs-variable">$</span> cd /<span class="hljs-keyword">data</span>/pcre<span class="hljs-literal">-8</span>.<span class="hljs-number">40</span>/

<span class="hljs-variable">$</span> ./configure

<span class="hljs-variable">$</span> make &amp;&amp; make install</code></pre></div>

<p>安装nginx</p>
<div class="hljs"><pre><code class="hljs autoit">$ cd /data/nginx<span class="hljs-number">-1.16</span><span class="hljs-number">.1</span>/

$ ./configure --prefix=/usr/<span class="hljs-keyword">local</span>/nginx --<span class="hljs-keyword">with</span>-http_ssl_module --<span class="hljs-keyword">with</span>-http_stub_status_module --<span class="hljs-keyword">with</span>-pcre=/usr/<span class="hljs-keyword">local</span>/src/pcre<span class="hljs-number">-8.40</span> --<span class="hljs-keyword">with</span>-zlib=/usr/<span class="hljs-keyword">local</span>/src/zlib<span class="hljs-number">-1.2</span><span class="hljs-number">.11</span> --<span class="hljs-keyword">with</span>-openssl=/usr/<span class="hljs-keyword">local</span>/src/openssl<span class="hljs-number">-1.1</span><span class="hljs-number">.0</span>f

$ make &amp;&amp; make install</code></pre></div>

<blockquote>
<p>Nginx系统自带安装包安装</p>
</blockquote>
<p>查看gcc相关的安装包</p>
<div class="hljs"><pre><code class="hljs applescript">$ yum <span class="hljs-built_in">list</span> gcc*</code></pre></div>

<p>安装依赖包</p>
<div class="hljs"><pre><code class="hljs nsis">$ yum install -y gcc-c++ openssl openssl-devel <span class="hljs-literal">zlib</span> <span class="hljs-literal">zlib</span>-devel pcre pcre-devel</code></pre></div>

<p>下载nginx</p>
<div class="hljs"><pre><code class="hljs elixir"><span class="hljs-variable">$ </span>cd /data

<span class="hljs-variable">$ </span>wget <span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/nginx.org/download</span><span class="hljs-regexp">/nginx-1.16.1.tar.gz</span></code></pre></div>

<p>安装nginx</p>
<div class="hljs"><pre><code class="hljs jboss-cli">$ <span class="hljs-keyword">cd</span> <span class="hljs-string">/data</span>

$ tar -zxvf nginx-1.16.1.tar.gz

$ <span class="hljs-keyword">cd</span> <span class="hljs-string">/nginx-1.16.1</span>

$ <span class="hljs-string">./configure</span> <span class="hljs-params">--prefix=/usr/local/nginx</span> <span class="hljs-params">--with-http_ssl_module</span> <span class="hljs-params">--with-http_stub_status_module</span> 

$ make &amp;&amp; make install</code></pre></div>

<p>配置Nginx开机自启</p>
<div class="hljs"><pre><code class="hljs awk">$ vim <span class="hljs-regexp">/etc/i</span>nit.d<span class="hljs-regexp">/nginx</span></code></pre></div>

<p>添加配置如下：</p>
<div class="hljs"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span>
	<span class="hljs-comment">#</span>
	<span class="hljs-comment"># chkconfig: - 85 15</span>
	<span class="hljs-comment"># description: Nginx is a World Wide Web server.</span>
	<span class="hljs-comment"># processname: nginx</span>
	
	nginx=/usr/<span class="hljs-built_in">local</span>/nginx/sbin/nginx
	conf=/usr/<span class="hljs-built_in">local</span>/nginx/conf/nginx.conf
	<span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span>
	start)
	<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"Starting Nginx"</span>
	<span class="hljs-variable">$nginx</span>
	<span class="hljs-built_in">echo</span> <span class="hljs-string">" done"</span>
	;;
	stop)
	<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"Stopping Nginx"</span>
	<span class="hljs-variable">$nginx</span> -s stop
	<span class="hljs-built_in">echo</span> <span class="hljs-string">" done"</span>
	;;
	<span class="hljs-built_in">test</span>)
	<span class="hljs-variable">$nginx</span> -t -c <span class="hljs-variable">$conf</span>
	;;
	reload)
	<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"Reloading Nginx"</span>
	<span class="hljs-variable">$nginx</span> -s reload
	<span class="hljs-built_in">echo</span> <span class="hljs-string">" done"</span>
	;;
	restart)
	sh <span class="hljs-variable">$0</span> stop
	sh <span class="hljs-variable">$0</span> start
	;;
	show)
	ps -aux|grep nginx
	;;
	*)
	<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"Usage: <span class="hljs-variable">$0</span> &#123;start|restart|reload|stop|test|show&#125;"</span>
	;;
	<span class="hljs-keyword">esac</span></code></pre></div>

<p>配置文件nginx的权限</p>
<div class="hljs"><pre><code class="hljs angelscript">$ chmod <span class="hljs-number">755</span> /etc/init.d/nginx</code></pre></div>

<p>设置开机自启动</p>
<div class="hljs"><pre><code class="hljs applescript">$ chkconfig nginx <span class="hljs-keyword">on</span></code></pre></div>


<blockquote>
<p>配置防火墙方式一（弃用firewalld使用iptables）</p>
</blockquote>
<p>停止和禁用firewalld</p>
<div class="hljs"><pre><code class="hljs gauss">$ systemctl <span class="hljs-keyword">stop</span> firewalld &amp;&amp; systemctl <span class="hljs-keyword">disable</span> firewalld</code></pre></div>

<p>安装iptables相关组件</p>
<div class="hljs"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> yum install -y iptables-services iptables-devel.x86_64 iptables.x86_64</span>

<span class="hljs-meta">$</span><span class="bash"> systemctl <span class="hljs-built_in">enable</span> iptables <span class="hljs-comment">#启用iptables</span></span>

<span class="hljs-meta">$</span><span class="bash"> systemctl start iptables  <span class="hljs-comment">#启动iptables</span></span>

<span class="hljs-meta">$</span><span class="bash"> systemctl status iptables <span class="hljs-comment">#查看iptables状态</span></span></code></pre></div>

<blockquote>
<p>==192.168.80.128== 和 ==192.168.80.129==配置防火墙</p>
</blockquote>
<p>keepalived服务器下的配置</p>
<div class="hljs"><pre><code class="hljs routeros">$ vim /etc/sysconfig/iptables

<span class="hljs-comment">#允许vrrp多播心跳(如果防火墙开启，这里不配置这个，就会出现裂脑)</span>
-I INPUT -p<span class="hljs-built_in"> vrrp </span>-j ACCEPT
<span class="hljs-comment">#开启80端口的访问(如果防火墙开启，不配置这个，vip的80端口将无法正常访问)</span>
-I INPUT -p tcp --dport 80 -j ACCEPT</code></pre></div>

<p>nginx服务器下配置</p>
<div class="hljs"><pre><code class="hljs pf"><span class="hljs-comment">#nginx默认监听的80端口 这里直接开启80端口的外网访问(不开启外网将无法正常反问对应服务器的nginx)</span>
-A INPUT -p tcp -m <span class="hljs-keyword">state</span> --state NEW -m tcp --dport <span class="hljs-number">80</span> -j ACCEPT</code></pre></div>

<p>重启防火墙</p>
<div class="hljs"><pre><code class="hljs css"><span class="hljs-selector-tag">systemctl</span> <span class="hljs-selector-tag">restart</span> <span class="hljs-selector-tag">iptables</span><span class="hljs-selector-class">.service</span></code></pre></div>

<blockquote>
<p>配置防火墙方式一（禁用防火墙，生产环境不推荐）</p>
</blockquote>
<div class="hljs"><pre><code class="hljs arduino">$ systemctl <span class="hljs-built_in">stop</span> iptables.service

$ systemctl <span class="hljs-built_in">stop</span> firewalld</code></pre></div>

<p>配置Nginx</p>
<div class="hljs"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> <span class="hljs-built_in">cd</span> /etc/init.d/</span>

<span class="hljs-meta">$</span><span class="bash"> vim realserver</span></code></pre></div>

<p>添加如下配置</p>
<div class="hljs"><pre><code class="hljs routeros"><span class="hljs-comment">#虚拟的vip 根据自己的实际情况定义</span>
<span class="hljs-attribute">SNS_VIP</span>=192.168.80.80
/etc/rc.d/init.d/functions
case <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> <span class="hljs-keyword">in</span>
start)
       ifconfig lo:0 <span class="hljs-variable">$SNS_VIP</span> netmask 255.255.255.255 broadcast <span class="hljs-variable">$SNS_VIP</span>
       /sbin<span class="hljs-built_in">/route </span><span class="hljs-builtin-name">add</span> -host <span class="hljs-variable">$SNS_VIP</span> dev lo:0
       echo <span class="hljs-string">"1"</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore
       echo <span class="hljs-string">"2"</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_announce
       echo <span class="hljs-string">"1"</span> &gt;/proc/sys/net/ipv4/conf/all/arp_ignore
       echo <span class="hljs-string">"2"</span> &gt;/proc/sys/net/ipv4/conf/all/arp_announce
       sysctl -p &gt;/dev/<span class="hljs-literal">null</span> 2&gt;&amp;1
       echo <span class="hljs-string">"RealServer Start OK"</span>
       ;;
stop)
       ifconfig lo:0 down
      <span class="hljs-built_in"> route </span>del <span class="hljs-variable">$SNS_VIP</span> &gt;/dev/<span class="hljs-literal">null</span> 2&gt;&amp;1
       echo <span class="hljs-string">"0"</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore
       echo <span class="hljs-string">"0"</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_announce
       echo <span class="hljs-string">"0"</span> &gt;/proc/sys/net/ipv4/conf/all/arp_ignore
       echo <span class="hljs-string">"0"</span> &gt;/proc/sys/net/ipv4/conf/all/arp_announce
       echo <span class="hljs-string">"RealServer Stoped"</span>
       ;;
*)
       echo <span class="hljs-string">"Usage: <span class="hljs-variable">$0</span> &#123;start|stop&#125;"</span>
       exit 1
esac
exit 0</code></pre></div>

<p>保存并设置脚本的执行权限</p>
<div class="hljs"><pre><code class="hljs angelscript">$ chmod <span class="hljs-number">755</span> /etc/init.d/realserver</code></pre></div>

<p>因为realserver脚本中用到了/etc/rc.d/init.d/functions，所以一并设置权限</p>
<div class="hljs"><pre><code class="hljs awk">$ chmod <span class="hljs-number">755</span> <span class="hljs-regexp">/etc/</span>rc.d<span class="hljs-regexp">/init.d/</span>functions</code></pre></div>

<p>执行脚本</p>
<div class="hljs"><pre><code class="hljs routeros">$<span class="hljs-built_in"> service </span>realserver start</code></pre></div>

<p>设置开机自启</p>
<div class="hljs"><pre><code class="hljs routeros">$ vim /etc/rc.d/rc.local

<span class="hljs-comment">#添加如下内容</span>
exec<span class="hljs-built_in"> service </span>realserver start

<span class="hljs-comment">#查看文件操作权限</span>

$ ll /etc/rc.d/rc.local

<span class="hljs-comment">#设置文件操作权限</span>

$ chmod +x /etc/rc.d/rc.local

或

$ chmod 755 /etc/rc.d/rc.local</code></pre></div>

<p>查看是否配置成功</p>
<p><img src="https://image.focusprogram.top/20191127234906.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt=""></p>
<blockquote>
<p>启动Keepalived</p>
</blockquote>
<div class="hljs"><pre><code class="hljs dts">$ <span class="hljs-meta-keyword">/etc/</span>init.d/keepalived start <span class="hljs-meta">#启动</span>

$ <span class="hljs-meta-keyword">/etc/</span>init.d/keepalived restart <span class="hljs-meta">#重启</span>

$ <span class="hljs-meta-keyword">/etc/</span>init.d/keepalived stop <span class="hljs-meta"># 停止</span></code></pre></div>

<p>检查主keepalived 启动后的配置情况<br>ip a<br>如果网卡下出现192.168.80.80（VIP）说明主已经启动成功</p>
<p><img src="https://image.focusprogram.top/20191127235938.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt=""></p>
<p>检查备keepalived 启动后的配置情况<br>ip a<br>备服务器的网卡下没有出现192.168.80.80（VIP）的ip，说明备服务正常<br>注:如果这里也出现了VIP，那么说明裂脑了，需要检查防火墙是否配置正确；是否允许了vrrp的多播通讯</p>
<p><img src="https://image.focusprogram.top/20191128000041.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt=""></p>
<blockquote>
<p>FastDFS集群搭建</p>
</blockquote>
<p>==192.168.80.130== 、==192.168.80.131== 、==192.168.80.132== 、==192.168.80.133== 、<br>==192.168.80.134== 、 ==192.168.80.135== 上安装FastDFS所需的安装环境</p>
<p>编译环境</p>
<div class="hljs"><pre><code class="hljs angelscript">yum install git gcc gcc-c++ make <span class="hljs-built_in">auto</span>make <span class="hljs-built_in">auto</span>conf libtool pcre pcre-devel zlib zlib-devel openssl-devel wget vim git -y</code></pre></div>

<p>配置防火墙开放相应的端口(禁用firewalld采用iptables配置)</p>
<div class="hljs"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> systemctl stop firewalld &amp;&amp; systemctl <span class="hljs-built_in">disable</span> firewalld</span>

<span class="hljs-meta">$</span><span class="bash"> yum install -y iptables-services iptables-devel.x86_64 iptables.x86_64</span>

<span class="hljs-meta">$</span><span class="bash"> vim /etc/sysconfig/iptables</span></code></pre></div>

<p>添加如何配置，开放相应的端口</p>
<div class="hljs"><pre><code class="hljs pf">-A INPUT -p tcp -m <span class="hljs-keyword">state</span> --state NEW -m tcp --dport <span class="hljs-number">80</span> -j ACCEPT

-A INPUT -p tcp -m <span class="hljs-keyword">state</span> --state NEW -m tcp --dport <span class="hljs-number">22122</span> -j ACCEPT

-A INPUT -p tcp -m <span class="hljs-keyword">state</span> --state NEW -m tcp --dport <span class="hljs-number">23000</span> -j ACCEPT</code></pre></div>

<p>启用iptables并设置开机自启</p>
<div class="hljs"><pre><code class="hljs pgsql">$ systemctl <span class="hljs-keyword">start</span> iptables &amp;&amp; systemctl <span class="hljs-keyword">enable</span> iptables</code></pre></div>

<p>查看防火墙对外开放的端口</p>
<div class="hljs"><pre><code class="hljs elixir"><span class="hljs-variable">$ </span>iptables -L -n</code></pre></div>

<p>创建下载文件目录和存储文件目录</p>
<div class="hljs"><pre><code class="hljs haskell">$ mkdir -p /<span class="hljs-class"><span class="hljs-keyword">data</span>/fastdfs/&#123;<span class="hljs-title">data</span>,<span class="hljs-title">store_path</span>&#125;</span>

$ mkdir -p /<span class="hljs-class"><span class="hljs-keyword">data</span>/soft &amp;&amp; cd /<span class="hljs-keyword">data</span>/soft</span></code></pre></div>

<p>安装libfatscommon</p>
<div class="hljs"><pre><code class="hljs vim">$ git clone http<span class="hljs-variable">s:</span>//github.<span class="hljs-keyword">com</span>/happyfish100/libfastcommon.git --depth <span class="hljs-number">1</span>

#$ <span class="hljs-keyword">cd</span> libfastcommon/

$ 
./<span class="hljs-keyword">make</span>.<span class="hljs-keyword">sh</span> &amp;&amp; ./<span class="hljs-keyword">make</span>.<span class="hljs-keyword">sh</span> install #编译安装</code></pre></div>

<p>安装FastDFS</p>
<div class="hljs"><pre><code class="hljs jboss-cli">$ <span class="hljs-keyword">cd</span> <span class="hljs-string">../</span> <span class="hljs-comment">#返回上一级目录</span>

$ git clone https:<span class="hljs-string">//github.com/happyfish100/fastdfs.git</span> <span class="hljs-params">--depth</span> 1

$ <span class="hljs-keyword">cd</span> fastdfs/

$ <span class="hljs-string">./make.sh</span> &amp;&amp; <span class="hljs-string">./make.sh</span> install <span class="hljs-comment">#编译安装</span></code></pre></div>

<p>配置文件准备</p>
<div class="hljs"><pre><code class="hljs mipsasm"><span class="hljs-comment">#编写所需文件执行脚本</span>

$ touch <span class="hljs-built_in">config</span>.<span class="hljs-keyword">sh </span>&amp;&amp; chmod <span class="hljs-number">777</span> <span class="hljs-built_in">config</span>.<span class="hljs-keyword">sh </span>&amp;&amp; vim <span class="hljs-built_in">config</span>.<span class="hljs-keyword">sh</span></code></pre></div>

<p>#添加如下内容</p>
<div class="hljs"><pre><code class="hljs awk"><span class="hljs-comment">#! /bin/bash</span>

<span class="hljs-comment">#Tracker文件</span>
cp <span class="hljs-regexp">/etc/</span>fdfs<span class="hljs-regexp">/tracker.conf.sample /</span>etc<span class="hljs-regexp">/fdfs/</span>tracker.conf

<span class="hljs-comment">#Storage文件</span>
cp <span class="hljs-regexp">/etc/</span>fdfs<span class="hljs-regexp">/storage.conf.sample /</span>etc<span class="hljs-regexp">/fdfs/</span>storage.conf

<span class="hljs-comment">#客户端文件(测试)</span>
cp <span class="hljs-regexp">/etc/</span>fdfs<span class="hljs-regexp">/client.conf.sample /</span>etc<span class="hljs-regexp">/fdfs/</span>client.conf

<span class="hljs-comment">#供nginx访问使用</span>
cp <span class="hljs-regexp">/data/</span>soft<span class="hljs-regexp">/fastdfs/</span>conf<span class="hljs-regexp">/http.conf /</span>etc<span class="hljs-regexp">/fdfs/</span>

<span class="hljs-comment">#供nginx访问使用</span>
cp <span class="hljs-regexp">/data/</span>soft<span class="hljs-regexp">/fastdfs/</span>conf<span class="hljs-regexp">/mime.types /</span>etc<span class="hljs-regexp">/fdfs/</span></code></pre></div>

<p>安装fastdfs-nginx-module</p>
<div class="hljs"><pre><code class="hljs ruby">$ cd ../ <span class="hljs-comment">#返回上一级目录</span>

$ git clone <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/happyfish</span>10<span class="hljs-number">0</span>/fastdfs-nginx-<span class="hljs-class"><span class="hljs-keyword">module</span>.<span class="hljs-title">git</span> --<span class="hljs-title">depth</span> 1</span>

$ cp /data/soft/fastdfs-nginx-<span class="hljs-class"><span class="hljs-keyword">module</span>/<span class="hljs-title">src</span>/<span class="hljs-title">mod_fastdfs</span>.<span class="hljs-title">conf</span> /<span class="hljs-title">etc</span>/<span class="hljs-title">fdfs</span></span></code></pre></div>

<p>安装nginx</p>
<div class="hljs"><pre><code class="hljs powershell"><span class="hljs-comment">#下载nginx压缩包</span>
<span class="hljs-variable">$</span> wget http://nginx.org/download/nginx<span class="hljs-literal">-1</span>.<span class="hljs-number">16.1</span>.tar.gz

<span class="hljs-comment">#解压</span>
<span class="hljs-variable">$</span> tar <span class="hljs-literal">-zxvf</span> nginx<span class="hljs-literal">-1</span>.<span class="hljs-number">16.1</span>.tar.gz 

<span class="hljs-variable">$</span> cd nginx<span class="hljs-literal">-1</span>.<span class="hljs-number">16.1</span>/

<span class="hljs-comment">#添加fastdfs-nginx-module模块</span>
<span class="hljs-variable">$</span> ./configure -<span class="hljs-literal">-add</span><span class="hljs-literal">-module</span>=/<span class="hljs-keyword">data</span>/soft/fastdfs<span class="hljs-literal">-nginx</span><span class="hljs-literal">-module</span>/src/ 

<span class="hljs-comment">#编译安装</span>
<span class="hljs-variable">$</span> make &amp;&amp; make install</code></pre></div>

<p>Tracker配置</p>
<p>#服务器ip为 ==192.168.80.130== 、==192.168.80.131==</p>
<div class="hljs"><pre><code class="hljs powershell"><span class="hljs-variable">$</span> vim /etc/fdfs/tracker.conf

<span class="hljs-comment">#需要修改的内容如下</span>
port=<span class="hljs-number">22122</span>  <span class="hljs-comment"># tracker服务器端口（默认22122,一般不修改）</span>
base_path=/<span class="hljs-keyword">data</span>/fastdfs/<span class="hljs-keyword">data</span>  <span class="hljs-comment"># 存储日志和数据的根目录</span></code></pre></div>

<p>Storage配置</p>
<p>#服务器ip为 ==192.168.80.132== 、==192.168.80.133== 、==192.168.80.134== 、==192.168.80.135==</p>
<div class="hljs"><pre><code class="hljs routeros">$ vim /etc/fdfs/storage.conf

<span class="hljs-comment">#需要修改的内容如下</span>
<span class="hljs-attribute">port</span>=23000  # storage服务端口（默认23000,一般不修改）

<span class="hljs-comment"># 数据和日志文件存储根目录</span>
<span class="hljs-attribute">base_path</span>=/data/fastdfs/data

 # 第一个存储目录
<span class="hljs-attribute">store_path0</span>=/data/fastdfs/store_path
<span class="hljs-attribute">tracker_server</span>=192.168.80.130:22122  # 服务器1
<span class="hljs-attribute">tracker_server</span>=192.168.80.131:22122  # 服务器2

<span class="hljs-comment"># http访问文件的端口(默认8888,看情况修改,和nginx中保持一致)</span>
http.<span class="hljs-attribute">server_port</span>=80</code></pre></div>

<p>client测试</p>
<p>#服务器ip为 ==192.168.80.132== 、==192.168.80.133== 、==192.168.80.134== 、==192.168.80.135==</p>
<div class="hljs"><pre><code class="hljs angelscript">$ vim /etc/fdfs/client.conf

#需要修改的内容如下
base_path=/home/moe/dfs
tracker_server=<span class="hljs-number">192.168</span><span class="hljs-number">.80</span><span class="hljs-number">.130</span>:<span class="hljs-number">22122</span>  # 服务器<span class="hljs-number">1</span>
tracker_server=<span class="hljs-number">192.168</span><span class="hljs-number">.80</span><span class="hljs-number">.131</span>:<span class="hljs-number">22122</span>  # 服务器<span class="hljs-number">2</span>

#保存后测试,返回ID表示成功 如：group1/M00/<span class="hljs-number">00</span>/<span class="hljs-number">00</span>/xx.tar.gz
fdfs_upload_file /etc/fdfs/client.conf /usr/local/src/nginx<span class="hljs-number">-1.15</span><span class="hljs-number">.4</span>.tar.gz</code></pre></div>


<p>配置nginx访问</p>
<p>#服务器ip为 ==192.168.80.132== 、==192.168.80.133== 、==192.168.80.134== 、==192.168.80.135==</p>
<div class="hljs"><pre><code class="hljs routeros">$ vim /etc/fdfs/mod_fastdfs.conf

<span class="hljs-comment">#需要修改的内容如下</span>
<span class="hljs-attribute">tracker_server</span>=192.168.80.131:22122  # 服务器1
<span class="hljs-attribute">tracker_server</span>=192.168.80.132:22122  # 服务器2

<span class="hljs-attribute">url_have_group_name</span>=<span class="hljs-literal">true</span>
<span class="hljs-attribute">store_path0</span>=/data/fastdfs/data

<span class="hljs-comment">#配置nginx.config</span>
$ vim /usr/local/nginx/conf/nginx.conf

<span class="hljs-comment">#添加如下配置</span>
server &#123;
    listen       80;    ## 该端口为storage.conf中的http.server_port相同
    server_name  localhost;
    location ~/group[0-9]/ &#123;
        ngx_fastdfs_module;
    &#125;
    error_page   500 502 503 504  /50x.html;
    location = /50x.html &#123;
    root   html;
    &#125;
&#125;</code></pre></div>

<blockquote>
<p>配置开机自启</p>
</blockquote>
<p>Nginx开机自启</p>
<div class="hljs"><pre><code class="hljs awk">$ vim <span class="hljs-regexp">/etc/i</span>nit.d<span class="hljs-regexp">/nginx</span></code></pre></div>

<p>添加配置如下：</p>
<div class="hljs"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># chkconfig: - 85 15</span>
<span class="hljs-comment"># description: Nginx is a World Wide Web server.</span>
<span class="hljs-comment"># processname: nginx</span>

nginx=/usr/<span class="hljs-built_in">local</span>/nginx/sbin/nginx
conf=/usr/<span class="hljs-built_in">local</span>/nginx/conf/nginx.conf
<span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span>
start)
<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"Starting Nginx"</span>
<span class="hljs-variable">$nginx</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">" done"</span>
;;
stop)
<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"Stopping Nginx"</span>
<span class="hljs-variable">$nginx</span> -s stop
<span class="hljs-built_in">echo</span> <span class="hljs-string">" done"</span>
;;
<span class="hljs-built_in">test</span>)
<span class="hljs-variable">$nginx</span> -t -c <span class="hljs-variable">$conf</span>
;;
reload)
<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"Reloading Nginx"</span>
<span class="hljs-variable">$nginx</span> -s reload
<span class="hljs-built_in">echo</span> <span class="hljs-string">" done"</span>
;;
restart)
sh <span class="hljs-variable">$0</span> stop
sh <span class="hljs-variable">$0</span> start
;;
show)
ps -aux|grep nginx
;;
*)
<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"Usage: <span class="hljs-variable">$0</span> &#123;start|restart|reload|stop|test|show&#125;"</span>
;;
<span class="hljs-keyword">esac</span></code></pre></div>

<p>配置文件nginx的权限</p>
<div class="hljs"><pre><code class="hljs angelscript">$ chmod <span class="hljs-number">755</span> /etc/init.d/nginx</code></pre></div>

<p>设置开机自启动</p>
<div class="hljs"><pre><code class="hljs applescript">$ chkconfig nginx <span class="hljs-keyword">on</span></code></pre></div>

<p>FastDFS配置开机自启</p>
<div class="hljs"><pre><code class="hljs gml">$ chmod +<span class="hljs-symbol">x</span> /etc/rc.d/rc.<span class="hljs-literal">local</span> 

$ vim /etc/rc.d/rc.<span class="hljs-literal">local</span></code></pre></div>
<p>添加如下命令</p>
<div class="hljs"><pre><code class="hljs awk">exec <span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/fdfs_trackerd /</span>etc<span class="hljs-regexp">/fdfs/</span>tracker.conf start

exec <span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/fdfs_storaged /</span>etc<span class="hljs-regexp">/fdfs/</span>storage.conf start</code></pre></div>

<p>操作FastDFS常用命令</p>
<div class="hljs"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> /etc/init.d/fdfs_trackerd start <span class="hljs-comment">#启动tracker服务</span></span>
<span class="hljs-meta">$</span><span class="bash"> /etc/init.d/fdfs_trackerd restart <span class="hljs-comment">#重启动tracker服务</span></span>
<span class="hljs-meta">$</span><span class="bash"> /etc/init.d/fdfs_trackerd stop <span class="hljs-comment">#停止tracker服务</span></span>
<span class="hljs-meta">$</span><span class="bash"> chkconfig fdfs_trackerd on <span class="hljs-comment">#自启动tracker服务</span></span>

<span class="hljs-meta">$</span><span class="bash"> /etc/init.d/fdfs_storaged start <span class="hljs-comment">#启动storage服务</span></span>
<span class="hljs-meta">$</span><span class="bash"> /etc/init.d/fdfs_storaged restart <span class="hljs-comment">#重动storage服务</span></span>
<span class="hljs-meta">$</span><span class="bash"> /etc/init.d/fdfs_storaged stop <span class="hljs-comment">#停止动storage服务</span></span>
<span class="hljs-meta">$</span><span class="bash"> chkconfig fdfs_storaged on <span class="hljs-comment">#自启动storage服务</span></span>

<span class="hljs-meta">$</span><span class="bash"> /usr/<span class="hljs-built_in">local</span>/nginx/sbin/nginx <span class="hljs-comment">#启动nginx</span></span>
<span class="hljs-meta">$</span><span class="bash"> /usr/<span class="hljs-built_in">local</span>/nginx/sbin/nginx -s reload <span class="hljs-comment">#重启nginx</span></span>
<span class="hljs-meta">$</span><span class="bash"> /usr/<span class="hljs-built_in">local</span>/nginx/sbin/nginx -s stop <span class="hljs-comment">#停止nginx</span></span></code></pre></div>

<p>检测集群</p>
<div class="hljs"><pre><code class="hljs awk">$ <span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/fdfs_monitor /</span>etc<span class="hljs-regexp">/fdfs/</span>storage.conf</code></pre></div>

<p><img src="https://image.focusprogram.top/Tracker-one.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt=""></p>
<p><img src="https://image.focusprogram.top/Tracker-two.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt=""></p>
<p>客户端测试上传</p>
<div class="hljs"><pre><code class="hljs gradle">#保存后测试,返回ID表示成功 如：group1<span class="hljs-regexp">/M00/</span><span class="hljs-number">00</span><span class="hljs-regexp">/00/</span>xx.tar.gz

$ fdfs_upload_file <span class="hljs-regexp">/etc/</span>fdfs<span class="hljs-regexp">/client.conf /</span>data<span class="hljs-regexp">/soft/</span>nginx-<span class="hljs-number">1.16</span>.<span class="hljs-number">1</span>.tar.gz

$ <span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/fdfs_test /</span>etc<span class="hljs-regexp">/fdfs/</span>client.conf upload <span class="hljs-regexp">/data/</span>soft<span class="hljs-regexp">/nginx-1.16.1.tar.gz</span></code></pre></div>

<p><img src="https://image.focusprogram.top/20191130184341.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt=""></p>
<p><img src="https://image.focusprogram.top/20191130184409.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt=""></p>
<p><img src="https://image.focusprogram.top/20191130184433.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt=""></p>
<p><img src="https://image.focusprogram.top/20191130184703.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt=""></p>
<p>若四台机器均可正常访问图片,至此两台Tracker+四台Storage正式搭建成功</p>
<blockquote>
<p>配置文件访问的负载均衡和高可用</p>
</blockquote>
<p>在==192.168.80.128== 和 ==192.168.80.129==上配置nginx配置文件</p>
<div class="hljs"><pre><code class="hljs stata">$ vim /usr/<span class="hljs-keyword">local</span>/nginx/<span class="hljs-keyword">conf</span>/nginx.<span class="hljs-keyword">conf</span></code></pre></div>

<p>修改配置如下：</p>
<div class="hljs"><pre><code class="hljs nginx"><span class="hljs-comment">#user  nobody;</span>
<span class="hljs-attribute">worker_processes</span>  <span class="hljs-number">1</span>;

<span class="hljs-comment">#error_log  logs/error.log;</span>
<span class="hljs-comment">#error_log  logs/error.log  notice;</span>
<span class="hljs-comment">#error_log  logs/error.log  info;</span>

<span class="hljs-comment">#pid        logs/nginx.pid;</span>


<span class="hljs-section">events</span> &#123;
    <span class="hljs-attribute">worker_connections</span>  <span class="hljs-number">1024</span>;
&#125;

<span class="hljs-section">http</span> &#123;
    <span class="hljs-attribute">include</span>       mime.types;
    <span class="hljs-attribute">default_type</span>  application/octet-stream;

    <span class="hljs-comment">#设置 group1 的服务器</span>
    <span class="hljs-attribute">upstream</span> fdfs_group1 &#123;
          <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.80.132:80</span> weight=<span class="hljs-number">1</span> max_fails=<span class="hljs-number">2</span> fail_timeout=<span class="hljs-number">30s</span>;
          <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.80.133:80</span> weight=<span class="hljs-number">1</span> max_fails=<span class="hljs-number">2</span> fail_timeout=<span class="hljs-number">30s</span>;
          <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.80.134:80</span> weight=<span class="hljs-number">1</span> max_fails=<span class="hljs-number">2</span> fail_timeout=<span class="hljs-number">30s</span>;
          <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.80.135:80</span> weight=<span class="hljs-number">1</span> max_fails=<span class="hljs-number">2</span> fail_timeout=<span class="hljs-number">30s</span>;
    &#125;
    

    <span class="hljs-comment">#log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span>
    <span class="hljs-comment">#                  '$status $body_bytes_sent "$http_referer" '</span>
    <span class="hljs-comment">#                  '"$http_user_agent" "$http_x_forwarded_for"';</span>

    <span class="hljs-comment">#access_log  logs/access.log  main;</span>

    <span class="hljs-attribute">sendfile</span>        <span class="hljs-literal">on</span>;
    <span class="hljs-comment">#tcp_nopush     on;</span>

    <span class="hljs-comment">#keepalive_timeout  0;</span>
    <span class="hljs-attribute">keepalive_timeout</span>  <span class="hljs-number">65</span>;

    <span class="hljs-comment">#gzip  on;</span>

    <span class="hljs-section">server</span> &#123;
        <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span>;
        <span class="hljs-attribute">server_name</span>  localhost;

        <span class="hljs-comment">#charset koi8-r;</span>

        <span class="hljs-comment">#access_log  logs/host.access.log  main;</span>

        <span class="hljs-comment">#location / &#123;</span>
        <span class="hljs-comment">#    root   html;</span>
        <span class="hljs-comment">#    index  index.html index.htm;</span>
        <span class="hljs-comment">#&#125;</span>

    	<span class="hljs-comment">#设置 group 的负载均衡参数</span>
    	<span class="hljs-attribute">location</span> /group1/M00 &#123;
    	      <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;
    	      <span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;
    	      <span class="hljs-attribute">proxy_pass</span> http://fdfs_group1;
    	&#125;

        <span class="hljs-comment">#error_page  404              /404.html;</span>

        <span class="hljs-comment"># redirect server error pages to the static page /50x.html</span>
        <span class="hljs-comment">#</span>
        <span class="hljs-attribute">error_page</span>   <span class="hljs-number">500</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span>  /50x.html;
        <span class="hljs-attribute">location</span> = /50x.html &#123;
            <span class="hljs-attribute">root</span>   html;
        &#125;

        <span class="hljs-comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span>
        <span class="hljs-comment">#</span>
        <span class="hljs-comment">#location ~ \.php$ &#123;</span>
        <span class="hljs-comment">#    proxy_pass   http://127.0.0.1;</span>
        <span class="hljs-comment">#&#125;</span>

        <span class="hljs-comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span>
        <span class="hljs-comment">#</span>
        <span class="hljs-comment">#location ~ \.php$ &#123;</span>
        <span class="hljs-comment">#    root           html;</span>
        <span class="hljs-comment">#    fastcgi_pass   127.0.0.1:9000;</span>
        <span class="hljs-comment">#    fastcgi_index  index.php;</span>
        <span class="hljs-comment">#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span>
        <span class="hljs-comment">#    include        fastcgi_params;</span>
        <span class="hljs-comment">#&#125;</span>

        <span class="hljs-comment"># deny access to .htaccess files, if Apache's document root</span>
        <span class="hljs-comment"># concurs with nginx's one</span>
        <span class="hljs-comment">#</span>
        <span class="hljs-comment">#location ~ /\.ht &#123;</span>
        <span class="hljs-comment">#    deny  all;</span>
        <span class="hljs-comment">#&#125;</span>
    &#125;


    <span class="hljs-comment"># another virtual host using mix of IP-, name-, and port-based configuration</span>
    <span class="hljs-comment">#</span>
    <span class="hljs-comment">#server &#123;</span>
    <span class="hljs-comment">#    listen       8000;</span>
    <span class="hljs-comment">#    listen       somename:8080;</span>
    <span class="hljs-comment">#    server_name  somename  alias  another.alias;</span>

    <span class="hljs-comment">#    location / &#123;</span>
    <span class="hljs-comment">#        root   html;</span>
    <span class="hljs-comment">#        index  index.html index.htm;</span>
    <span class="hljs-comment">#    &#125;</span>
    <span class="hljs-comment">#&#125;</span>


    <span class="hljs-comment"># HTTPS server</span>
    <span class="hljs-comment">#</span>
    <span class="hljs-comment">#server &#123;</span>
    <span class="hljs-comment">#    listen       443 ssl;</span>
    <span class="hljs-comment">#    server_name  localhost;</span>

    <span class="hljs-comment">#    ssl_certificate      cert.pem;</span>
    <span class="hljs-comment">#    ssl_certificate_key  cert.key;</span>

    <span class="hljs-comment">#    ssl_session_cache    shared:SSL:1m;</span>
    <span class="hljs-comment">#    ssl_session_timeout  5m;</span>

    <span class="hljs-comment">#    ssl_ciphers  HIGH:!aNULL:!MD5;</span>
    <span class="hljs-comment">#    ssl_prefer_server_ciphers  on;</span>

    <span class="hljs-comment">#    location / &#123;</span>
    <span class="hljs-comment">#        root   html;</span>
    <span class="hljs-comment">#        index  index.html index.htm;</span>
    <span class="hljs-comment">#    &#125;</span>
    <span class="hljs-comment">#&#125;</span>

&#125;</code></pre></div>

<p>通过VIP主机访问，访问成功，至此LVS+Keepalived+Nginx+FastDFS高可用集群全部搭建成功</p>
<p><img src="https://image.focusprogram.top/20191130191442.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt=""></p>
<blockquote>
<p>Fast分组集群</p>
</blockquote>
<p>修改==192.168.80.132== 和 ==192.168.80.133== 的Storage.conf如下：</p>
<div class="hljs"><pre><code class="hljs ini"><span class="hljs-attr">base_path</span>=/data/fastdfs/data
<span class="hljs-attr">store_path0</span>=/data/fastdfs/store_path
<span class="hljs-attr">tracker_server</span>=<span class="hljs-number">192.168</span>.<span class="hljs-number">80.130</span>:<span class="hljs-number">22122</span>
<span class="hljs-attr">tracker_server</span>=<span class="hljs-number">192.168</span>.<span class="hljs-number">80.131</span>:<span class="hljs-number">22122</span>
<span class="hljs-attr">group_name</span>=group1</code></pre></div>

<p>修改==192.168.80.132== 和 ==192.168.80.133== 的mod_fastdfs.conf如下：</p>
<div class="hljs"><pre><code class="hljs ini"><span class="hljs-attr">base_path</span>=/data/fastdfs/storage
<span class="hljs-comment">#保留默认值也可以</span>
<span class="hljs-attr">connect_timeout</span>=<span class="hljs-number">10</span>                       
<span class="hljs-attr">tracker_server</span>=<span class="hljs-number">192.168</span>.<span class="hljs-number">80.130</span>:<span class="hljs-number">22122</span>
<span class="hljs-attr">tracker_server</span>=<span class="hljs-number">192.168</span>.<span class="hljs-number">80.131</span>:<span class="hljs-number">22122</span>
<span class="hljs-attr">url_have_group_name</span> = <span class="hljs-literal">true</span>                <span class="hljs-comment">#url中是否加上group名</span>
<span class="hljs-attr">store_path0</span>=/data/fastdfs/store_path
<span class="hljs-attr">group_name</span>=group1                        <span class="hljs-comment">#当前storage所属的组名</span>
<span class="hljs-attr">group_count</span> = <span class="hljs-number">2</span>                    <span class="hljs-comment">#组的数量，示例中共两组：group1、group2</span>

<span class="hljs-section">[group1]</span>
<span class="hljs-attr">group_name</span>=group1
<span class="hljs-attr">storage_server_port</span>=<span class="hljs-number">23000</span>
<span class="hljs-attr">store_path_count</span>=<span class="hljs-number">1</span>
<span class="hljs-attr">store_path0</span>=/data/fastdfs/store_path

<span class="hljs-section">[group2]</span>
<span class="hljs-attr">group_name</span>=group2
<span class="hljs-attr">storage_server_port</span>=<span class="hljs-number">23000</span>
<span class="hljs-attr">store_path_count</span>=<span class="hljs-number">1</span>
<span class="hljs-attr">store_path0</span>=/data/fastdfs/store_path</code></pre></div>

<p>修改==192.168.80.134== 和 ==192.168.80.135== 的Storage.conf如下：</p>
<div class="hljs"><pre><code class="hljs ini"><span class="hljs-attr">base_path</span>=/data/fastdfs/data
<span class="hljs-attr">store_path0</span>=/data/fastdfs/store_path
<span class="hljs-attr">tracker_server</span>=<span class="hljs-number">192.168</span>.<span class="hljs-number">80.130</span>:<span class="hljs-number">22122</span>
<span class="hljs-attr">tracker_server</span>=<span class="hljs-number">192.168</span>.<span class="hljs-number">80.131</span>:<span class="hljs-number">22122</span>
<span class="hljs-attr">group_name</span>=group2</code></pre></div>

<p>修改==192.168.80.134== 和 ==192.168.80.135== 的mod_fastdfs.conf如下：</p>
<div class="hljs"><pre><code class="hljs ini"><span class="hljs-attr">base_path</span>=/data/fastdfs/storage
<span class="hljs-comment">#保留默认值也可以</span>
<span class="hljs-attr">connect_timeout</span>=<span class="hljs-number">10</span>                       
<span class="hljs-attr">tracker_server</span>=<span class="hljs-number">192.168</span>.<span class="hljs-number">80.130</span>:<span class="hljs-number">22122</span>
<span class="hljs-attr">tracker_server</span>=<span class="hljs-number">192.168</span>.<span class="hljs-number">80.131</span>:<span class="hljs-number">22122</span>
<span class="hljs-attr">url_have_group_name</span> = <span class="hljs-literal">true</span>                <span class="hljs-comment">#url中是否加上group名</span>
<span class="hljs-attr">store_path0</span>=/data/fastdfs/store_path
<span class="hljs-attr">group_name</span>=group2                        <span class="hljs-comment">#当前storage所属的组名</span>
<span class="hljs-attr">group_count</span> = <span class="hljs-number">2</span>                    <span class="hljs-comment">#组的数量，示例中共两组：group1、group2</span>

<span class="hljs-section">[group1]</span>
<span class="hljs-attr">group_name</span>=group1
<span class="hljs-attr">storage_server_port</span>=<span class="hljs-number">23000</span>
<span class="hljs-attr">store_path_count</span>=<span class="hljs-number">1</span>
<span class="hljs-attr">store_path0</span>=/data/fastdfs/store_path

<span class="hljs-section">[group2]</span>
<span class="hljs-attr">group_name</span>=group2
<span class="hljs-attr">storage_server_port</span>=<span class="hljs-number">23000</span>
<span class="hljs-attr">store_path_count</span>=<span class="hljs-number">1</span>
<span class="hljs-attr">store_path0</span>=/data/fastdfs/store_path</code></pre></div>

<p>修改==192.168.80.128== 和 ==192.168.80.129== 的nginx.conf如下：</p>
<div class="hljs"><pre><code class="hljs nginx">
<span class="hljs-comment">#user  nobody;</span>
<span class="hljs-attribute">worker_processes</span>  <span class="hljs-number">1</span>;

<span class="hljs-comment">#error_log  logs/error.log;</span>
<span class="hljs-comment">#error_log  logs/error.log  notice;</span>
<span class="hljs-comment">#error_log  logs/error.log  info;</span>

<span class="hljs-comment">#pid        logs/nginx.pid;</span>


<span class="hljs-section">events</span> &#123;
    <span class="hljs-attribute">worker_connections</span>  <span class="hljs-number">1024</span>;
&#125;

<span class="hljs-section">http</span> &#123;
    <span class="hljs-attribute">include</span>       mime.types;
    <span class="hljs-attribute">default_type</span>  application/octet-stream;

    <span class="hljs-comment">#设置 group1 的服务器</span>
    <span class="hljs-attribute">upstream</span> fdfs_group1 &#123;
          <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.80.132:80</span> weight=<span class="hljs-number">1</span> max_fails=<span class="hljs-number">2</span> fail_timeout=<span class="hljs-number">30s</span>;
          <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.80.133:80</span> weight=<span class="hljs-number">1</span> max_fails=<span class="hljs-number">2</span> fail_timeout=<span class="hljs-number">30s</span>;
    &#125;

    <span class="hljs-comment">#设置 group1 的服务器</span>
    <span class="hljs-attribute">upstream</span> fdfs_group2 &#123;
	  <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.80.134:80</span> weight=<span class="hljs-number">1</span> max_fails=<span class="hljs-number">2</span> fail_timeout=<span class="hljs-number">30s</span>;
	  <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.80.135:80</span> weight=<span class="hljs-number">1</span> max_fails=<span class="hljs-number">2</span> fail_timeout=<span class="hljs-number">30s</span>;
    &#125;
    

    <span class="hljs-comment">#log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span>
    <span class="hljs-comment">#                  '$status $body_bytes_sent "$http_referer" '</span>
    <span class="hljs-comment">#                  '"$http_user_agent" "$http_x_forwarded_for"';</span>

    <span class="hljs-comment">#access_log  logs/access.log  main;</span>

    <span class="hljs-attribute">sendfile</span>        <span class="hljs-literal">on</span>;
    <span class="hljs-comment">#tcp_nopush     on;</span>

    <span class="hljs-comment">#keepalive_timeout  0;</span>
    <span class="hljs-attribute">keepalive_timeout</span>  <span class="hljs-number">65</span>;

    <span class="hljs-comment">#gzip  on;</span>

    <span class="hljs-section">server</span> &#123;
        <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span>;
        <span class="hljs-attribute">server_name</span>  <span class="hljs-number">192.168.80.128</span>;

        <span class="hljs-comment">#charset koi8-r;</span>

        <span class="hljs-comment">#access_log  logs/host.access.log  main;</span>

        <span class="hljs-comment">#location / &#123;</span>
        <span class="hljs-comment">#    root   html;</span>
        <span class="hljs-comment">#    index  index.html index.htm;</span>
        <span class="hljs-comment">#&#125;</span>

	<span class="hljs-comment">#设置 group1 的负载均衡参数</span>
	<span class="hljs-attribute">location</span> /group1/M00 &#123;
	      <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;
	      <span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;
	      <span class="hljs-attribute">proxy_pass</span> http://fdfs_group1;
	&#125;

	<span class="hljs-comment">#设置 group2 的负载均衡参数</span>
	<span class="hljs-attribute">location</span> /group2/M00 &#123;
	      <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;
	      <span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;
	      <span class="hljs-attribute">proxy_pass</span> http://fdfs_group2;
	&#125;
	                                                          

        <span class="hljs-comment">#error_page  404              /404.html;</span>

        <span class="hljs-comment"># redirect server error pages to the static page /50x.html</span>
        <span class="hljs-comment">#</span>
        <span class="hljs-attribute">error_page</span>   <span class="hljs-number">500</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span>  /50x.html;
        <span class="hljs-attribute">location</span> = /50x.html &#123;
            <span class="hljs-attribute">root</span>   html;
        &#125;

        <span class="hljs-comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span>
        <span class="hljs-comment">#</span>
        <span class="hljs-comment">#location ~ \.php$ &#123;</span>
        <span class="hljs-comment">#    proxy_pass   http://127.0.0.1;</span>
        <span class="hljs-comment">#&#125;</span>

        <span class="hljs-comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span>
        <span class="hljs-comment">#</span>
        <span class="hljs-comment">#location ~ \.php$ &#123;</span>
        <span class="hljs-comment">#    root           html;</span>
        <span class="hljs-comment">#    fastcgi_pass   127.0.0.1:9000;</span>
        <span class="hljs-comment">#    fastcgi_index  index.php;</span>
        <span class="hljs-comment">#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span>
        <span class="hljs-comment">#    include        fastcgi_params;</span>
        <span class="hljs-comment">#&#125;</span>

        <span class="hljs-comment"># deny access to .htaccess files, if Apache's document root</span>
        <span class="hljs-comment"># concurs with nginx's one</span>
        <span class="hljs-comment">#</span>
        <span class="hljs-comment">#location ~ /\.ht &#123;</span>
        <span class="hljs-comment">#    deny  all;</span>
        <span class="hljs-comment">#&#125;</span>
    &#125;


    <span class="hljs-comment"># another virtual host using mix of IP-, name-, and port-based configuration</span>
    <span class="hljs-comment">#</span>
    <span class="hljs-comment">#server &#123;</span>
    <span class="hljs-comment">#    listen       8000;</span>
    <span class="hljs-comment">#    listen       somename:8080;</span>
    <span class="hljs-comment">#    server_name  somename  alias  another.alias;</span>

    <span class="hljs-comment">#    location / &#123;</span>
    <span class="hljs-comment">#        root   html;</span>
    <span class="hljs-comment">#        index  index.html index.htm;</span>
    <span class="hljs-comment">#    &#125;</span>
    <span class="hljs-comment">#&#125;</span>


    <span class="hljs-comment"># HTTPS server</span>
    <span class="hljs-comment">#</span>
    <span class="hljs-comment">#server &#123;</span>
    <span class="hljs-comment">#    listen       443 ssl;</span>
    <span class="hljs-comment">#    server_name  localhost;</span>

    <span class="hljs-comment">#    ssl_certificate      cert.pem;</span>
    <span class="hljs-comment">#    ssl_certificate_key  cert.key;</span>

    <span class="hljs-comment">#    ssl_session_cache    shared:SSL:1m;</span>
    <span class="hljs-comment">#    ssl_session_timeout  5m;</span>

    <span class="hljs-comment">#    ssl_ciphers  HIGH:!aNULL:!MD5;</span>
    <span class="hljs-comment">#    ssl_prefer_server_ciphers  on;</span>

    <span class="hljs-comment">#    location / &#123;</span>
    <span class="hljs-comment">#        root   html;</span>
    <span class="hljs-comment">#        index  index.html index.htm;</span>
    <span class="hljs-comment">#    &#125;</span>
    <span class="hljs-comment">#&#125;</span>

&#125;</code></pre></div>

<blockquote>
<p>Nginx追加https模块</p>
</blockquote>
<p>查看nginx原有的模块</p>
<div class="hljs"><pre><code class="hljs awk">$ <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/nginx/</span>sbin<span class="hljs-regexp">/nginx -V</span></code></pre></div>

<p>添加Https模块</p>
<div class="hljs"><pre><code class="hljs jboss-cli">$ <span class="hljs-keyword">cd</span> <span class="hljs-string">/data/nginx-1.16.1</span>

$ <span class="hljs-string">./configure</span> <span class="hljs-params">--with-http_stub_status_module</span> <span class="hljs-params">--with-http_ssl_module</span></code></pre></div>

<p>编译不覆盖安装</p>
<div class="hljs"><pre><code class="hljs awk">$ make

$ cp .<span class="hljs-regexp">/objs/</span>nginx <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/nginx/</span>sbin<span class="hljs-regexp">/</span></code></pre></div>
            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/k-focusprogram.gitee.io/categories/Devops/">Devops</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/k-focusprogram.gitee.io/tags/Docker/">Docker</a>
                    
                      <a class="hover-with-bg" href="/k-focusprogram.gitee.io/tags/FastDFS/">FastDFS</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/k-focusprogram.gitee.io/2020/07/11/Jenkins%E9%83%A8%E7%BD%B2%E9%A1%B9%E7%9B%AE/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Jenkins部署项目</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/k-focusprogram.gitee.io/2020/07/11/Docker-Nginx-FastDFS%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%90%AD%E5%BB%BA/">
                        <span class="hidden-mobile">Docker+Nginx+FastDFS分布式文件系统搭建</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
              <!-- Comments -->
              <div class="comments" id="comments">
                
                
  <div id="vcomments"></div>
  <script type="text/javascript">
    function loadValine() {
      addScript('https://cdn.staticfile.org/valine/1.4.14/Valine.min.js', function () {
        new Valine({
          el: "#vcomments",
          app_id: "XjjXuhrzyfTeHFAzz4XEQWeA-gzGzoHsz",
          app_key: "VOV2U2qRAhtqyuBiioUEvrNV",
          placeholder: "留下您想说的话吧(*^▽^*)",
          path: window.location.pathname,
          avatar: "wavatar",
          meta: ["nick","mail"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: true,
          recordIP: true,
          serverURLs: "",
        });
      });
    }
    createObserver(loadValine, 'vcomments');
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://valine.js.org" target="_blank" rel="nofollow noopener noopener">comments
      powered by Valine.</a></noscript>


              </div>
            
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!--
<script src="https://utteranc.es/client.js"
        repo="FocusProgram/focusprogram.github.io"
        issue-term="title"
        label="utterances"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
-->


<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
<div id="dark-div">
  <a id="dark" onclick="switchDarkMode()"></a>
</div>
<script>
  var isNight = new Date().getHours() >= 22 || new Date().getHours() < 7;
  if( matchMedia('(prefers-color-scheme: dark)').matches || isNight || localStorage.getItem('dark') === '1') {
    if(!(isNight&&localStorage.getItem('noDark') === '1')) {
      document.body.classList.add('dark');
    }
  }
  document.getElementById('dark').innerHTML = document.querySelector("body").classList.contains("dark")?"🌙":"🌞";
</script>
  <div class="text-center py-3">
    <div>
      <a rel="nofollow noopener"><span>永远执着&nbsp;&nbsp;</span></a>
      <i class="iconfont icon-love"></i>
      <a rel="nofollow noopener">
        <span>&nbsp;&nbsp;永远热爱</span></a>
    </div>
    
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


    
  <!-- 备案信息 -->
  <div class="beian">
    <img src="https://image.focusprogram.top/icp_beian.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" style="margin-top:-5px">
    <a href="http://beian.miit.gov.cn/" target="_blank"
       rel="nofollow noopener">苏ICP备19063834号-1</a>
    
      <a
        href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44030602004695"
        rel="nofollow noopener"
        class="beian-police"
        target="_blank"
      >
        <span class="beian-police-sep">&nbsp;|&nbsp;</span>
        
          <img src="/k-focusprogram.gitee.io/img/police_beian.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt="police-icon" />
        
        <span>苏公安网备44030602004695号</span>
      </a>
     
  </div>


    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/k-focusprogram.gitee.io/js/debouncer.js" ></script>
<script  src="/k-focusprogram.gitee.io/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/k-focusprogram.gitee.io/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/k-focusprogram.gitee.io/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: 'article.markdown-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "Lvs+Keepalived+Nginx+FastDFS分布式文件系统高可用集群搭建&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/k-focusprogram.gitee.io/js/local-search.js" ></script>
  <script>
    var path = "/k-focusprogram.gitee.io/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>









  <script>(function (i, s, o, g, r, a, m) {
      i['DaoVoiceObject'] = r;
      i[r] = i[r] ||
        function () {
          (i[r].q = i[r].q || []).push(arguments);
        };
      i[r].l = 1 * new Date();
      a = s.createElement(o);
      m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      a.charset = 'utf-8';
      m.parentNode.insertBefore(a, m);
    })(window, document, 'script', ('https:' === document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/98eb4efd.js", 'daovoice');
    daovoice('init', {
      app_id: "98eb4efd",
    });
    daovoice('update');
  </script>









  

  

  

  

  

  




</body>
</html>