<!DOCTYPE html>
<html lang="zh-CN">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/k-focusprogram.gitee.io/img/Mr.Kong.jpg">
  <link rel="icon" type="image/png" href="/k-focusprogram.gitee.io/img/Mr.Kong.jpg">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="May you experience the pain and happiness in your life">
  <meta name="author" content="Mr.Kong">
  <meta name="keywords" content="">
  <title>ELK详解 - Mr.Kong Blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/k-focusprogram.gitee.io/lib/hint/hint.min.css" />

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/dark.min.css" />
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_yg9cfy8wd6.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/k-focusprogram.gitee.io/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/k-focusprogram.gitee.io/js/utils.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/k-focusprogram.gitee.io/">&nbsp;<strong>Mr.Kong</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/k-focusprogram.gitee.io/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/k-focusprogram.gitee.io/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/k-focusprogram.gitee.io/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/k-focusprogram.gitee.io/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/k-focusprogram.gitee.io/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/k-focusprogram.gitee.io/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-bookmark-fill"></i>
                开源地址
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="https://gitee.com/FocusProgram/" target="_blank" rel="noopener">
                    
                    Gitee
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://github.com/FocusProgram/" target="_blank" rel="noopener">
                    
                    GitHub
                  </a>
                
              </div>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/k-focusprogram.gitee.io/img/neight.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-07-11 16:26">
      2020年7月11日 下午
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      3.6k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      49
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
              <p class="note note-info">
                
                  本文最后更新于：2 天前
                
              </p>
            
            <article class="markdown-body">
              <p><strong>ELK详解</strong></p>
<hr>
<h1 id="1-什么是ELK"><a href="#1-什么是ELK" class="headerlink" title="1. 什么是ELK?"></a>1. 什么是ELK?</h1><blockquote>
<p>ELK 是elastic公司提供的一套完整的日志收集以及展示的解决方案，是三个产品的首字母缩写，分别是ElasticSearch、Logstash 和 Kibana。</p>
<p><a href="https://github.com/elastic/elasticsearch" target="_blank" rel="noopener">ElasticSearch</a> 简称ES，它是一个实时的分布式搜索和分析引擎，它可以用于全文搜索，结构化搜索以及分析。它是一个建立在全文搜索引擎 Apache Lucene 基础上的搜索引擎，使用 Java 语言编写。</p>
<p><a href="https://github.com/elastic/logstash" target="_blank" rel="noopener">Logstash</a> 是一个具有实时传输能力的数据收集引擎，用来进行数据收集（如：读取文本文件）、解析，并将数据发送给ES。</p>
<p><a href="https://github.com/elastic/kibana" target="_blank" rel="noopener">Kibana</a> 为 Elasticsearch 提供了分析和可视化的 Web 平台。它可以在 Elasticsearch 的索引中查找，交互数据，并生成各种维度表格、图形。</p>
</blockquote>
<h1 id="2-ELK用途？"><a href="#2-ELK用途？" class="headerlink" title="2. ELK用途？"></a>2. ELK用途？</h1><blockquote>
<p>传统意义上，ELK是作为替代Splunk的一个开源解决方案。Splunk 是日志分析领域的领导者。日志分析并不仅仅包括系统产生的错误日志，异常，也包括业务逻辑，或者任何文本类的分析。而基于日志的分析，能够在其上产生非常多的解决方案，譬如：</p>
<p>1.问题排查。我们常说，运维和开发这一辈子无非就是和问题在战斗，所以这个说起来很朴实的四个字，其实是沉甸甸的。很多公司其实不缺钱，就要稳定，而要稳定，就要运维和开发能够快速的定位问题，甚至防微杜渐，把问题杀死在摇篮里。日志分析技术显然问题排查的基石。基于日志做问题排查，还有一个很帅的技术，叫全链路追踪，比如阿里的eagleeye<br>或者Google的dapper，也算是日志分析技术里的一种。</p>
<p>2.监控和预警。 日志，监控，预警是相辅相成的。基于日志的监控，预警使得运维有自己的机械战队，大大节省人力以及延长运维的寿命。</p>
<p>3.关联事件。多个数据源产生的日志进行联动分析，通过某种分析算法，就能够解决生活中各个问题。比如金融里的风险欺诈等。这个可以可以应用到无数领域了，取决于你的想象力。</p>
<p>4.数据分析。 这个对于数据分析师，还有算法工程师都是有所裨益的。</p>
</blockquote>
<h1 id="3-ELK架构设计"><a href="#3-ELK架构设计" class="headerlink" title="3. ELK架构设计"></a>3. ELK架构设计</h1><p><img src="http://image.focusprogram.top/elk.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt=""></p>
<h1 id="4-ELK搭建部署"><a href="#4-ELK搭建部署" class="headerlink" title="4. ELK搭建部署"></a>4. ELK搭建部署</h1><h2 id="4-1-环境准备"><a href="#4-1-环境准备" class="headerlink" title="4.1 环境准备"></a>4.1 环境准备</h2><h3 id="4-1-1-所需配置"><a href="#4-1-1-所需配置" class="headerlink" title="4.1.1 所需配置"></a>4.1.1 所需配置</h3><table>
<thead>
<tr>
<th>服务名</th>
<th>Docker ip地址</th>
<th>宿主机ip地址</th>
<th>开放端口</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>elasticsearch</td>
<td>172.20.0.2</td>
<td>192.168.80.130</td>
<td>9200、9300</td>
<td>搜索</td>
</tr>
<tr>
<td>elasticsearch-head</td>
<td>172.20.0.3</td>
<td>192.168.80.130</td>
<td>9100</td>
<td>elasticsearch界面管理</td>
</tr>
<tr>
<td>logstash</td>
<td>172.20.0.4</td>
<td>192.168.80.130</td>
<td>5044</td>
<td>日志收集</td>
</tr>
<tr>
<td>kibana</td>
<td>172.20.0.5</td>
<td>192.168.80.130</td>
<td>5061</td>
<td>展示、监控</td>
</tr>
</tbody></table>
<h3 id="4-1-2-创建网络"><a href="#4-1-2-创建网络" class="headerlink" title="4.1.2 创建网络"></a>4.1.2 创建网络</h3><div class="hljs"><pre><code class="hljs routeros">$ docker<span class="hljs-built_in"> network </span>create <span class="hljs-attribute">--driver</span>=bridge <span class="hljs-attribute">--subnet</span>=172.30.0.1/16 elk-network</code></pre></div>

<h2 id="4-2-elasticsearch"><a href="#4-2-elasticsearch" class="headerlink" title="4.2 elasticsearch"></a>4.2 elasticsearch</h2><blockquote>
<p>Elasticsearch 是一个分布式可扩展的实时搜索和分析引擎,一个建立在全文搜索引擎 Apache Lucene(TM) 基础上的搜索引擎.当然 Elasticsearch 并不仅仅是 Lucene 那么简单，它不仅包括了全文搜索功能，还可以进行以下工作:</p>
<p>分布式实时文件存储，并将每一个字段都编入索引，使其可以被搜索。<br>实时分析的分布式搜索引擎。<br>可以扩展到上百台服务器，处理PB级别的结构化或非结构化数据。</p>
</blockquote>
<h3 id="4-2-1-elasticsearch配置文件"><a href="#4-2-1-elasticsearch配置文件" class="headerlink" title="4.2.1 elasticsearch配置文件"></a>4.2.1 elasticsearch配置文件</h3><p>编辑配置文件es.yml</p>
<div class="hljs"><pre><code class="hljs css"><span class="hljs-selector-tag">cluster</span><span class="hljs-selector-class">.name</span>: <span class="hljs-selector-tag">elasticsearch</span>
<span class="hljs-selector-tag">node</span><span class="hljs-selector-class">.name</span>: <span class="hljs-selector-tag">es</span>
<span class="hljs-selector-tag">network</span><span class="hljs-selector-class">.bind_host</span>: 0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span>
<span class="hljs-selector-tag">network</span><span class="hljs-selector-class">.publish_host</span>: 172<span class="hljs-selector-class">.30</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.2</span>
<span class="hljs-selector-tag">http</span><span class="hljs-selector-class">.port</span>: 9200
<span class="hljs-selector-tag">transport</span><span class="hljs-selector-class">.tcp</span><span class="hljs-selector-class">.port</span>: 9300
<span class="hljs-selector-tag">http</span><span class="hljs-selector-class">.cors</span><span class="hljs-selector-class">.enabled</span>: <span class="hljs-selector-tag">true</span>
<span class="hljs-selector-tag">http</span><span class="hljs-selector-class">.cors</span><span class="hljs-selector-class">.allow-origin</span>: "*"
<span class="hljs-selector-tag">node</span><span class="hljs-selector-class">.master</span>: <span class="hljs-selector-tag">true</span>
<span class="hljs-selector-tag">node</span><span class="hljs-selector-class">.data</span>: <span class="hljs-selector-tag">true</span>
<span class="hljs-selector-tag">discovery</span><span class="hljs-selector-class">.zen</span><span class="hljs-selector-class">.ping</span><span class="hljs-selector-class">.unicast</span><span class="hljs-selector-class">.hosts</span>: <span class="hljs-selector-attr">[<span class="hljs-string">"172.30.0.2:9300"</span>]</span>
<span class="hljs-selector-tag">discovery</span><span class="hljs-selector-class">.zen</span><span class="hljs-selector-class">.minimum_master_nodes</span>: 1</code></pre></div>

<h3 id="4-2-2-docker-compose配置文件"><a href="#4-2-2-docker-compose配置文件" class="headerlink" title="4.2.2 docker-compose配置文件"></a>4.2.2 docker-compose配置文件</h3><p>编辑docker-compose配置文件elasticsearch.yml</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">elasticsearch:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">elasticsearch</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">elasticsearch</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-attr">default:</span>
        <span class="hljs-attr">ipv4_address:</span> <span class="hljs-number">172.30</span><span class="hljs-number">.0</span><span class="hljs-number">.2</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">9200</span><span class="hljs-string">:9200</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">9300</span><span class="hljs-string">:9300</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./es.yml:/usr/share/elasticsearch/config/elasticsearch.yml</span>
      <span class="hljs-comment"># 指定Ik分词器和拼音分词器可以支持中文和拼音搜索</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./plugins:/usr/share/elasticsearch/plugins</span>

  <span class="hljs-attr">elasticsearch-head:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">mobz/elasticsearch-head:5</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">elasticsearch-head</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-attr">default:</span>
        <span class="hljs-attr">ipv4_address:</span> <span class="hljs-number">172.30</span><span class="hljs-number">.0</span><span class="hljs-number">.3</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">9100</span><span class="hljs-string">:9100</span>
    <span class="hljs-attr">links:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">elasticsearch:elasticsearch</span>

<span class="hljs-attr">networks:</span>
  <span class="hljs-attr">default:</span>
    <span class="hljs-attr">external:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">elk-network</span></code></pre></div>

<h3 id="4-2-3-构建脚本"><a href="#4-2-3-构建脚本" class="headerlink" title="4.2.3 构建脚本"></a>4.2.3 构建脚本</h3><p>编辑构建脚本build.sh</p>
<div class="hljs"><pre><code class="hljs css"><span class="hljs-selector-tag">docker-compose</span> <span class="hljs-selector-tag">-f</span> <span class="hljs-selector-tag">elasticsearch</span><span class="hljs-selector-class">.yml</span> <span class="hljs-selector-tag">stop</span>

<span class="hljs-selector-tag">docker-compose</span> <span class="hljs-selector-tag">-f</span> <span class="hljs-selector-tag">elasticsearch</span><span class="hljs-selector-class">.yml</span> <span class="hljs-selector-tag">rm</span> <span class="hljs-selector-tag">--force</span>

<span class="hljs-selector-tag">docker-compose</span> <span class="hljs-selector-tag">-f</span> <span class="hljs-selector-tag">elasticsearch</span><span class="hljs-selector-class">.yml</span> <span class="hljs-selector-tag">up</span> <span class="hljs-selector-tag">-d</span></code></pre></div>

<p>执行构建脚本</p>
<div class="hljs"><pre><code class="hljs n1ql">$ chmod +x <span class="hljs-keyword">build</span>.sh &amp;&amp; ./<span class="hljs-keyword">build</span>.sh</code></pre></div>

<p>构建成功显示如下：</p>
<p><img src="http://image.focusprogram.top/20200511112646.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt=""></p>
<p>测试是否成功启动</p>
<div class="hljs"><pre><code class="hljs gams"><span class="hljs-symbol">$</span> curl http:<span class="hljs-comment">//localhost:9200</span></code></pre></div>

<p>发现无法访问，查看日志，报错信息如下：</p>
<div class="hljs"><pre><code class="hljs vim"><span class="hljs-built_in">max</span> virtual memory areas <span class="hljs-keyword">vm</span>.max_map_count [<span class="hljs-number">65530</span>] <span class="hljs-keyword">is</span> too low, increase <span class="hljs-keyword">to</span> at least [<span class="hljs-number">262144</span>]</code></pre></div>

<p>解决方法如下：</p>
<ol>
<li>临时生效，重启服务器后实效</li>
</ol>
<div class="hljs"><pre><code class="hljs vim">执行命令：

sysctl -<span class="hljs-keyword">w</span> <span class="hljs-keyword">vm</span>.max_map_count=<span class="hljs-number">262144</span>

查看结果：

sysctl -<span class="hljs-keyword">a</span>|<span class="hljs-keyword">grep</span> <span class="hljs-keyword">vm</span>.max_map_count

显示：

<span class="hljs-keyword">vm</span>.max_map_count = <span class="hljs-number">262144</span></code></pre></div>

<ol start="2">
<li>永久有效</li>
</ol>
<div class="hljs"><pre><code class="hljs vim">$ <span class="hljs-keyword">vim</span> /etc/sysctl.<span class="hljs-keyword">conf</span>

<span class="hljs-keyword">vm</span>.max_map_count=<span class="hljs-number">262144</span></code></pre></div>

<p>修改重新编译后，再次访问，显示如下，则启动成功：</p>
<div class="hljs"><pre><code class="hljs groovy">$ curl <span class="hljs-string">http:</span><span class="hljs-comment">//localhost:9200</span>

&#123;
  <span class="hljs-string">"name"</span> : <span class="hljs-string">"es"</span>,
  <span class="hljs-string">"cluster_name"</span> : <span class="hljs-string">"elasticsearch"</span>,
  <span class="hljs-string">"cluster_uuid"</span> : <span class="hljs-string">"uDlzhbhgT-6B9Zv_KGD29Q"</span>,
  <span class="hljs-string">"version"</span> : &#123;
    <span class="hljs-string">"number"</span> : <span class="hljs-string">"5.6.12"</span>,
    <span class="hljs-string">"build_hash"</span> : <span class="hljs-string">"cfe3d9f"</span>,
    <span class="hljs-string">"build_date"</span> : <span class="hljs-string">"2018-09-10T20:12:43.732Z"</span>,
    <span class="hljs-string">"build_snapshot"</span> : <span class="hljs-literal">false</span>,
    <span class="hljs-string">"lucene_version"</span> : <span class="hljs-string">"6.6.1"</span>
  &#125;,
  <span class="hljs-string">"tagline"</span> : <span class="hljs-string">"You Know, for Search"</span>
&#125;</code></pre></div>

<p>访问 <a href="http://192.168.80.130:9100/" target="_blank" rel="noopener">http://192.168.80.130:9100/</a>,显示如下，则说明elasticsearch-head启动成功</p>
<p><img src="http://image.focusprogram.top/20200511113534.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt=""></p>
<p><strong>注意事项：</strong></p>
<ul>
<li><ol>
<li>修改vm.max_map_count参数，否则无法正常启动</li>
</ol>
</li>
<li><ol start="2">
<li>plugins中ik分词器插件版本要与elasticsearch版本保持一致，否则无法正常使用中文分词</li>
</ol>
</li>
</ul>
<h3 id="4-3-4-elasticsearch常用命令"><a href="#4-3-4-elasticsearch常用命令" class="headerlink" title="4.3.4 elasticsearch常用命令"></a>4.3.4 elasticsearch常用命令</h3><ol>
<li>查询全部</li>
</ol>
<div class="hljs"><pre><code class="hljs routeros"><span class="hljs-builtin-name">GET</span> _search
&#123;
  <span class="hljs-string">"query"</span>: &#123;
    <span class="hljs-string">"match_all"</span>: &#123;&#125;
  &#125;
&#125;</code></pre></div>

<ol start="2">
<li>查询索引以及索引映射类型</li>
</ol>
<div class="hljs"><pre><code class="hljs routeros"><span class="hljs-builtin-name">GET</span> user/_search

<span class="hljs-builtin-name">GET</span> user/_mapping

<span class="hljs-builtin-name">GET</span> product/_search

<span class="hljs-builtin-name">GET</span> product/_mapping</code></pre></div>

<ol start="3">
<li>删除索引</li>
</ol>
<div class="hljs"><pre><code class="hljs routeros">DELETE user

DELETE product</code></pre></div>

<ol start="4">
<li>重新指定文档类型映射IK分词类型</li>
</ol>
<div class="hljs"><pre><code class="hljs dts">POST <span class="hljs-meta-keyword">/product/</span>_mapping/product
&#123;
      <span class="hljs-string">"product"</span>: &#123;
        <span class="hljs-string">"properties"</span>: &#123;
          <span class="hljs-string">"@timestamp"</span>: &#123;
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"date"</span>
          &#125;,
          <span class="hljs-string">"@version"</span>: &#123;
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
            <span class="hljs-string">"fields"</span>: &#123;
              <span class="hljs-string">"keyword"</span>: &#123;
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span>,
                <span class="hljs-string">"ignore_above"</span>: <span class="hljs-number">256</span>
              &#125;
            &#125;
          &#125;,
          <span class="hljs-string">"attribute_list"</span>: &#123;
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
            <span class="hljs-string">"fields"</span>: &#123;
              <span class="hljs-string">"keyword"</span>: &#123;
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span>,
                <span class="hljs-string">"ignore_above"</span>: <span class="hljs-number">256</span>
              &#125;
            &#125;
          &#125;,
          <span class="hljs-string">"category_id"</span>: &#123;
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"long"</span>
          &#125;,
          <span class="hljs-string">"created_time"</span>: &#123;
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"date"</span>
          &#125;,
          <span class="hljs-string">"detail"</span>: &#123;
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
             <span class="hljs-string">"analyzer"</span>:<span class="hljs-string">"ik_smart"</span>,
            <span class="hljs-string">"search_analyzer"</span>:<span class="hljs-string">"ik_smart"</span>

          &#125;,
          <span class="hljs-string">"id"</span>: &#123;
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"long"</span>
          &#125;,
          <span class="hljs-string">"main_image"</span>: &#123;
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
            <span class="hljs-string">"fields"</span>: &#123;
              <span class="hljs-string">"keyword"</span>: &#123;
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span>,
                <span class="hljs-string">"ignore_above"</span>: <span class="hljs-number">256</span>
              &#125;
            &#125;
          &#125;,
          <span class="hljs-string">"name"</span>: &#123;
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
            <span class="hljs-string">"analyzer"</span>:<span class="hljs-string">"ik_smart"</span>,
            <span class="hljs-string">"search_analyzer"</span>:<span class="hljs-string">"ik_smart"</span>

          &#125;,
          <span class="hljs-string">"revision"</span>: &#123;
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"long"</span>
          &#125;,
          <span class="hljs-string">"status"</span>: &#123;
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"long"</span>
          &#125;,
          <span class="hljs-string">"sub_images"</span>: &#123;
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
            <span class="hljs-string">"fields"</span>: &#123;
              <span class="hljs-string">"keyword"</span>: &#123;
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span>,
                <span class="hljs-string">"ignore_above"</span>: <span class="hljs-number">256</span>
              &#125;
            &#125;
          &#125;,
          <span class="hljs-string">"subtitle"</span>: &#123;
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
          <span class="hljs-string">"analyzer"</span>:<span class="hljs-string">"ik_smart"</span>,
         <span class="hljs-string">"search_analyzer"</span>:<span class="hljs-string">"ik_smart"</span>

          &#125;,
          <span class="hljs-string">"updated_time"</span>: &#123;
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"date"</span>
          &#125;
        &#125;
      &#125;
&#125;</code></pre></div>

<ol start="5">
<li>添加自定义拼音和IK分词插件</li>
</ol>
<div class="hljs"><pre><code class="hljs ada">PUT /product
&#123;
   <span class="hljs-string">"settings"</span>: &#123;
        <span class="hljs-string">"analysis"</span>: &#123;
            <span class="hljs-string">"analyzer"</span>: &#123;
                <span class="hljs-string">"ik_smart_pinyin"</span>: &#123;
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"custom"</span>,
                    <span class="hljs-string">"tokenizer"</span>: <span class="hljs-string">"ik_smart"</span>,
                    <span class="hljs-string">"filter"</span>: [<span class="hljs-string">"my_pinyin"</span>, <span class="hljs-string">"word_delimiter"</span>]
                &#125;,
                <span class="hljs-string">"ik_max_word_pinyin"</span>: &#123;
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"custom"</span>,
                    <span class="hljs-string">"tokenizer"</span>: <span class="hljs-string">"ik_max_word"</span>,
                    <span class="hljs-string">"filter"</span>: [<span class="hljs-string">"my_pinyin"</span>, <span class="hljs-string">"word_delimiter"</span>]
                &#125;
            &#125;,
            <span class="hljs-string">"filter"</span>: &#123;
                <span class="hljs-string">"my_pinyin"</span>: &#123;
                    <span class="hljs-string">"type"</span> : "<span class="hljs-type">pinyin</span><span class="hljs-string">",</span>
<span class="hljs-string">                    "</span>keep_separate_first_letter<span class="hljs-string">" : true,</span>
<span class="hljs-string">                    "</span>keep_full_pinyin<span class="hljs-string">" : true,</span>
<span class="hljs-string">                    "</span>keep_original<span class="hljs-string">" : true,</span>
<span class="hljs-string">                    "</span>limit_first_letter_length<span class="hljs-string">" : 16,</span>
<span class="hljs-string">                    "</span>lowercase<span class="hljs-string">" : true,</span>
<span class="hljs-string">                    "</span>remove_duplicated_term<span class="hljs-string">" : true </span>
<span class="hljs-string">                &#125;</span>
<span class="hljs-string">            &#125;</span>
<span class="hljs-string">        &#125;</span>
<span class="hljs-string">  &#125;</span>
<span class="hljs-string">  </span>
<span class="hljs-string">&#125;</span>
<span class="hljs-string"></span>
<span class="hljs-string"># 重新指定文档类型映射自定义分词类型</span>
<span class="hljs-string">POST /product/_mapping/product</span>
<span class="hljs-string">&#123;</span>
<span class="hljs-string">  "</span>product<span class="hljs-string">": &#123;</span>
<span class="hljs-string">	"</span>properties<span class="hljs-string">": &#123;</span>
<span class="hljs-string">	  "</span>@timestamp<span class="hljs-string">": &#123;</span>
<span class="hljs-string">		"</span><span class="hljs-keyword">type</span><span class="hljs-string">": "</span>date<span class="hljs-string">"</span>
<span class="hljs-string">	  &#125;,</span>
<span class="hljs-string">	  "</span>@version<span class="hljs-string">": &#123;</span>
<span class="hljs-string">		"</span><span class="hljs-keyword">type</span><span class="hljs-string">": "</span>text<span class="hljs-string">",</span>
<span class="hljs-string">		"</span>fields<span class="hljs-string">": &#123;</span>
<span class="hljs-string">		  "</span>keyword<span class="hljs-string">": &#123;</span>
<span class="hljs-string">			"</span><span class="hljs-keyword">type</span><span class="hljs-string">": "</span>keyword<span class="hljs-string">",</span>
<span class="hljs-string">			"</span>ignore_above<span class="hljs-string">": 256</span>
<span class="hljs-string">		  &#125;</span>
<span class="hljs-string">		&#125;</span>
<span class="hljs-string">	  &#125;,</span>
<span class="hljs-string">	  "</span>attribute_list<span class="hljs-string">": &#123;</span>
<span class="hljs-string">		"</span><span class="hljs-keyword">type</span><span class="hljs-string">": "</span>text<span class="hljs-string">",</span>
<span class="hljs-string">		"</span>fields<span class="hljs-string">": &#123;</span>
<span class="hljs-string">		  "</span>keyword<span class="hljs-string">": &#123;</span>
<span class="hljs-string">			"</span><span class="hljs-keyword">type</span><span class="hljs-string">": "</span>keyword<span class="hljs-string">",</span>
<span class="hljs-string">			"</span>ignore_above<span class="hljs-string">": 256</span>
<span class="hljs-string">		  &#125;</span>
<span class="hljs-string">		&#125;</span>
<span class="hljs-string">	  &#125;,</span>
<span class="hljs-string">	  "</span>category_id<span class="hljs-string">": &#123;</span>
<span class="hljs-string">		"</span><span class="hljs-keyword">type</span><span class="hljs-string">": "</span>long<span class="hljs-string">"</span>
<span class="hljs-string">	  &#125;,</span>
<span class="hljs-string">	  "</span>created_time<span class="hljs-string">": &#123;</span>
<span class="hljs-string">		"</span><span class="hljs-keyword">type</span><span class="hljs-string">": "</span>date<span class="hljs-string">"</span>
<span class="hljs-string">	  &#125;,</span>
<span class="hljs-string">	  "</span>detail<span class="hljs-string">": &#123;</span>
<span class="hljs-string">		"</span><span class="hljs-keyword">type</span><span class="hljs-string">": "</span>text<span class="hljs-string">",</span>
<span class="hljs-string">		 "</span>analyzer<span class="hljs-string">":"</span>ik_smart_pinyin<span class="hljs-string">",</span>
<span class="hljs-string">		"</span>search_analyzer<span class="hljs-string">":"</span>ik_smart_pinyin<span class="hljs-string">"</span>
<span class="hljs-string"></span>
<span class="hljs-string">	  &#125;,</span>
<span class="hljs-string">	  "</span>id<span class="hljs-string">": &#123;</span>
<span class="hljs-string">		"</span><span class="hljs-keyword">type</span><span class="hljs-string">": "</span>long<span class="hljs-string">"</span>
<span class="hljs-string">	  &#125;,</span>
<span class="hljs-string">	  "</span>main_image<span class="hljs-string">": &#123;</span>
<span class="hljs-string">		"</span><span class="hljs-keyword">type</span><span class="hljs-string">": "</span>text<span class="hljs-string">",</span>
<span class="hljs-string">		"</span>fields<span class="hljs-string">": &#123;</span>
<span class="hljs-string">		  "</span>keyword<span class="hljs-string">": &#123;</span>
<span class="hljs-string">			"</span><span class="hljs-keyword">type</span><span class="hljs-string">": "</span>keyword<span class="hljs-string">",</span>
<span class="hljs-string">			"</span>ignore_above<span class="hljs-string">": 256</span>
<span class="hljs-string">		  &#125;</span>
<span class="hljs-string">		&#125;</span>
<span class="hljs-string">	  &#125;,</span>
<span class="hljs-string">	  "</span>name<span class="hljs-string">": &#123;</span>
<span class="hljs-string">		"</span><span class="hljs-keyword">type</span><span class="hljs-string">": "</span>text<span class="hljs-string">",</span>
<span class="hljs-string">		"</span>analyzer<span class="hljs-string">":"</span>ik_smart_pinyin<span class="hljs-string">",</span>
<span class="hljs-string">		"</span>search_analyzer<span class="hljs-string">":"</span>ik_smart_pinyin<span class="hljs-string">"</span>
<span class="hljs-string"></span>
<span class="hljs-string">	  &#125;,</span>
<span class="hljs-string">	  "</span>revision<span class="hljs-string">": &#123;</span>
<span class="hljs-string">		"</span><span class="hljs-keyword">type</span><span class="hljs-string">": "</span>long<span class="hljs-string">"</span>
<span class="hljs-string">	  &#125;,</span>
<span class="hljs-string">	  "</span>status<span class="hljs-string">": &#123;</span>
<span class="hljs-string">		"</span><span class="hljs-keyword">type</span><span class="hljs-string">": "</span>long<span class="hljs-string">"</span>
<span class="hljs-string">	  &#125;,</span>
<span class="hljs-string">	  "</span>sub_images<span class="hljs-string">": &#123;</span>
<span class="hljs-string">		"</span><span class="hljs-keyword">type</span><span class="hljs-string">": "</span>text<span class="hljs-string">",</span>
<span class="hljs-string">		"</span>fields<span class="hljs-string">": &#123;</span>
<span class="hljs-string">		  "</span>keyword<span class="hljs-string">": &#123;</span>
<span class="hljs-string">			"</span><span class="hljs-keyword">type</span><span class="hljs-string">": "</span>keyword<span class="hljs-string">",</span>
<span class="hljs-string">			"</span>ignore_above<span class="hljs-string">": 256</span>
<span class="hljs-string">		  &#125;</span>
<span class="hljs-string">		&#125;</span>
<span class="hljs-string">	  &#125;,</span>
<span class="hljs-string">	  "</span>subtitle<span class="hljs-string">": &#123;</span>
<span class="hljs-string">		"</span><span class="hljs-keyword">type</span><span class="hljs-string">": "</span>text<span class="hljs-string">",</span>
<span class="hljs-string">	  "</span>analyzer<span class="hljs-string">":"</span>ik_smart<span class="hljs-string">",</span>
<span class="hljs-string">	 "</span>search_analyzer<span class="hljs-string">":"</span>ik_smart<span class="hljs-string">"</span>
<span class="hljs-string"></span>
<span class="hljs-string">	  &#125;,</span>
<span class="hljs-string">	  "</span>updated_time<span class="hljs-string">": &#123;</span>
<span class="hljs-string">		"</span><span class="hljs-keyword">type</span><span class="hljs-string">": "</span>date<span class="hljs-string">"</span>
<span class="hljs-string">	  &#125;</span>
<span class="hljs-string">	&#125;</span>
<span class="hljs-string">  &#125;</span>
<span class="hljs-string">&#125;</span></code></pre></div>

<h2 id="4-3-logstash"><a href="#4-3-logstash" class="headerlink" title="4.3 logstash"></a>4.3 logstash</h2><h3 id="4-3-1-处理过程"><a href="#4-3-1-处理过程" class="headerlink" title="4.3.1 处理过程"></a>4.3.1 处理过程</h3><p><img src="http://image.focusprogram.top/20200511114553.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt=""></p>
<p>如上图，Logstash的数据处理过程主要包括：Inputs, Filters, Outputs 三部分， 另外在Inputs和Outputs中可以使用Codecs对数据格式进行处理。这四个部分均以插件形式存在，用户通过定义pipeline配置文件，设置需要使用的input，filter，output, codec插件，以实现特定的数据采集，数据处理，数据输出等功能  </p>
<ul>
<li><strong>Inputs</strong>：用于从数据源获取数据，常见的插件如file, syslog, redis, beats 等<a href="https://www.elastic.co/guide/en/logstash/5.6/input-plugins.html" target="_blank" rel="noopener">详细参考</a></li>
<li><strong>Filters</strong>：用于处理数据如格式转换，数据派生等，常见的插件如grok, mutate, drop,  clone, geoip等<a href="https://www.elastic.co/guide/en/logstash/5.6/output-plugins.html" target="_blank" rel="noopener">详细参考</a>  </li>
<li><strong>Outputs</strong>：用于数据输出，常见的插件如elastcisearch，file, graphite, statsd等<a href="https://www.elastic.co/guide/en/logstash/5.6/filter-plugins.html" target="_blank" rel="noopener">详细参考</a></li>
<li><strong>Codecs</strong>：Codecs不是一个单独的流程，而是在输入和输出等插件中用于数据转换的模块，用于对数据进行编码处理，常见的插件如json，multiline<a href="https://www.elastic.co/guide/en/logstash/5.6/codec-plugins.html" target="_blank" rel="noopener">详细参考</a></li>
</ul>
<h3 id="4-3-2-执行模型"><a href="#4-3-2-执行模型" class="headerlink" title="4.3.2 执行模型"></a>4.3.2 执行模型</h3><ul>
<li>每个Input启动一个线程，从对应数据源获取数据  </li>
<li>Input会将数据写入一个队列：默认为内存中的有界队列（意外停止会导致数据丢失）。为了防止数丢失Logstash提供了两个特性：<ul>
<li>Persistent Queues：通过磁盘上的queue来防止数据丢失</li>
<li>Dead Letter Queues：保存无法处理的event（仅支持Elasticsearch作为输出源）</li>
</ul>
</li>
<li>Logstash会有多个pipeline worker, 每一个pipeline worker会从队列中取一批数据，然后执行filter和output（worker数目及每次处理的数据量均由配置确定）</li>
</ul>
<h3 id="4-3-3-收集数据来源"><a href="#4-3-3-收集数据来源" class="headerlink" title="4.3.3 收集数据来源"></a>4.3.3 收集数据来源</h3><h4 id="4-3-3-1-kafka数据来源"><a href="#4-3-3-1-kafka数据来源" class="headerlink" title="4.3.3.1 kafka数据来源"></a>4.3.3.1 kafka数据来源</h4><p>编辑logstash_kafka.conf</p>
<div class="hljs"><pre><code class="hljs puppet"><span class="hljs-keyword">input</span> &#123;
  kafka &#123;
    <span class="hljs-attr">bootstrap_servers</span> =&gt; <span class="hljs-string">"192.168.80.130:9092"</span>
    <span class="hljs-attr">topics</span> =&gt; [<span class="hljs-string">"my_log"</span>]
  &#125;
&#125;
<span class="hljs-keyword">output</span> &#123;
    stdout &#123; <span class="hljs-attr">codec</span> =&gt; rubydebug &#125;
    <span class="hljs-keyword">elasticsearch</span> &#123;
       <span class="hljs-attr">hosts</span> =&gt; [<span class="hljs-string">"192.168.80.130:9200"</span>]
       <span class="hljs-attr">index</span> =&gt; <span class="hljs-string">"my_log"</span>
    &#125;
&#125;</code></pre></div>

<h4 id="4-3-3-2-tomcat数据来源"><a href="#4-3-3-2-tomcat数据来源" class="headerlink" title="4.3.3.2 tomcat数据来源"></a>4.3.3.2 tomcat数据来源</h4><p>编辑logstash_tomcat.conf</p>
<div class="hljs"><pre><code class="hljs puppet"><span class="hljs-keyword">input</span> &#123;
    <span class="hljs-comment"># 从文件读取日志信息 输送到控制台</span>
    file &#123;
        <span class="hljs-attr">path</span> =&gt; <span class="hljs-string">"/tomcat.logs"</span>
        <span class="hljs-attr">codec</span> =&gt; <span class="hljs-string">"json"</span> <span class="hljs-comment">## 以JSON格式读取日志</span>
        <span class="hljs-attr">type</span> =&gt; <span class="hljs-string">"elasticsearch"</span>
        <span class="hljs-attr">start_position</span> =&gt; <span class="hljs-string">"beginning"</span>
    &#125;
&#125;

<span class="hljs-comment"># filter &#123;</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># &#125;</span>

<span class="hljs-keyword">output</span> &#123;
    <span class="hljs-comment"># 标准输出</span>
    <span class="hljs-comment"># stdout &#123;&#125;</span>
    <span class="hljs-comment"># 输出进行格式化，采用Ruby库来解析日志</span>
     stdout &#123; <span class="hljs-attr">codec</span> =&gt; rubydebug &#125;
         <span class="hljs-keyword">elasticsearch</span> &#123;
        <span class="hljs-attr">hosts</span> =&gt; [<span class="hljs-string">"192.168.80.130:9200"</span>]
        <span class="hljs-attr">index</span> =&gt; <span class="hljs-string">"tomcat-%&#123;+YYYY.MM.dd&#125;"</span>
    &#125;
&#125;</code></pre></div>

<h4 id="4-3-3-3-mysql数据来源"><a href="#4-3-3-3-mysql数据来源" class="headerlink" title="4.3.3.3 mysql数据来源"></a>4.3.3.3 mysql数据来源</h4><p>编辑mysql_tables.conf</p>
<div class="hljs"><pre><code class="hljs puppet"><span class="hljs-keyword">input</span> &#123;
  jdbc &#123;
    <span class="hljs-attr">jdbc_driver_library</span> =&gt; <span class="hljs-string">"/mysql-connector-java-5.1.46.jar"</span>
    <span class="hljs-attr">jdbc_driver_class</span> =&gt; <span class="hljs-string">"com.mysql.jdbc.Driver"</span>
    <span class="hljs-attr">jdbc_connection_string</span> =&gt; <span class="hljs-string">"jdbc:mysql://114.55.34.44:3306/elk"</span>
    <span class="hljs-attr">jdbc_user</span> =&gt; <span class="hljs-string">"root"</span>
    <span class="hljs-attr">jdbc_password</span> =&gt; <span class="hljs-string">"root"</span>
    <span class="hljs-attr">schedule</span> =&gt; <span class="hljs-string">"* * * * *"</span>
    <span class="hljs-attr">statement</span> =&gt; <span class="hljs-string">"SELECT * FROM user WHERE update_time &gt;= :sql_last_value"</span>
    <span class="hljs-attr">use_column_value</span> =&gt; <span class="hljs-keyword">true</span>
    <span class="hljs-attr">tracking_column_type</span> =&gt; <span class="hljs-string">"timestamp"</span>
    <span class="hljs-attr">tracking_column</span> =&gt; <span class="hljs-string">"update_time"</span>
    <span class="hljs-attr">last_run_metadata_path</span> =&gt; <span class="hljs-string">"syncpoint_table"</span>
    <span class="hljs-attr">type</span> =&gt; <span class="hljs-string">"user"</span>
  &#125;

  <span class="hljs-keyword">jdbc</span> &#123;
    <span class="hljs-attr">jdbc_driver_library</span> =&gt; <span class="hljs-string">"/mysql-connector-java-5.1.46.jar"</span>
    <span class="hljs-attr">jdbc_driver_class</span> =&gt; <span class="hljs-string">"com.mysql.jdbc.Driver"</span>
    <span class="hljs-attr">jdbc_connection_string</span> =&gt; <span class="hljs-string">"jdbc:mysql://114.55.34.44:3306/goods"</span>
    <span class="hljs-attr">jdbc_user</span> =&gt; <span class="hljs-string">"root"</span>
    <span class="hljs-attr">jdbc_password</span> =&gt; <span class="hljs-string">"root"</span>
    <span class="hljs-attr">schedule</span> =&gt; <span class="hljs-string">"* * * * *"</span>
    <span class="hljs-attr">statement</span> =&gt; <span class="hljs-string">"SELECT * FROM product WHERE updated_time &gt;= :sql_last_value"</span>
    <span class="hljs-attr">use_column_value</span> =&gt; <span class="hljs-keyword">true</span>
    <span class="hljs-attr">tracking_column_type</span> =&gt; <span class="hljs-string">"timestamp"</span>
    <span class="hljs-attr">tracking_column</span> =&gt; <span class="hljs-string">"update_time"</span>
    <span class="hljs-attr">last_run_metadata_path</span> =&gt; <span class="hljs-string">"syncpoint_table"</span>
    <span class="hljs-attr">type</span> =&gt; <span class="hljs-string">"product"</span>
  &#125;

&#125;

<span class="hljs-keyword">output</span> &#123;
    
    <span class="hljs-keyword">if</span> [<span class="hljs-built_in">type</span>] == <span class="hljs-string">"user"</span>&#123;     	
       elasticsearch &#123; 
        <span class="hljs-comment"># ES的IP地址及端口</span>
        <span class="hljs-attr">hosts</span> =&gt; [<span class="hljs-string">"192.168.80.130:9200"</span>]
        <span class="hljs-comment"># 索引名称 可自定义</span>
        <span class="hljs-attr">index</span> =&gt; <span class="hljs-string">"user"</span> 
        <span class="hljs-comment"># 需要关联的数据库中有有一个id字段，对应类型中的id</span>
        <span class="hljs-attr">document_id</span> =&gt; <span class="hljs-string">"%&#123;id&#125;"</span>
        <span class="hljs-attr">document_type</span> =&gt; <span class="hljs-string">"user"</span>
       &#125;
    &#125;

    if [type] == <span class="hljs-string">"product"</span>&#123;
       <span class="hljs-keyword">elasticsearch</span> &#123;  
        <span class="hljs-comment"># ES的IP地址及端口</span>
        <span class="hljs-attr">hosts</span> =&gt; [<span class="hljs-string">"192.168.80.130:9200"</span>]
        <span class="hljs-comment"># 索引名称 可自定义</span>
        <span class="hljs-attr">index</span> =&gt; <span class="hljs-string">"product"</span> 
        <span class="hljs-comment"># 需要关联的数据库中有有一个id字段，对应类型中的id</span>
        <span class="hljs-attr">document_id</span> =&gt; <span class="hljs-string">"%&#123;id&#125;"</span>
        <span class="hljs-attr">document_type</span> =&gt; <span class="hljs-string">"product"</span>
       &#125;
    &#125;
    
    <span class="hljs-keyword">stdout</span> &#123;
        <span class="hljs-comment"># JSON格式输出</span>
        <span class="hljs-attr">codec</span> =&gt; json_lines
    &#125;
&#125;</code></pre></div>

<p>配置文件说明</p>
<div class="hljs"><pre><code class="hljs avrasm"><span class="hljs-symbol">jdbc_driver_library:</span> jdbc mysql 驱动的路径
<span class="hljs-symbol">jdbc_driver_class:</span> 驱动类的名字，mysql 填 <span class="hljs-keyword">com</span>.mysql.jdbc.Driver 就好了
<span class="hljs-symbol">jdbc_connection_string:</span> mysql 地址
<span class="hljs-symbol">jdbc_user:</span> mysql 用户
<span class="hljs-symbol">jdbc_password:</span> mysql 密码
<span class="hljs-symbol">schedule:</span> 执行 sql 时机，类似 crontab 的调度
<span class="hljs-symbol">statement:</span> 要执行的 sql，以 “:” 开头是定义的变量，可以通过 parameters 来设置变量，这里的 sql_last_value 是内置的变量，表示上一次 sql 执行中 update_time 的值，这里 update_time 条件是 &gt;= 因为时间有可能相等，没有等号可能会漏掉一些增量
<span class="hljs-symbol">use_column_value:</span> 使用递增列的值
<span class="hljs-symbol">tracking_column_type:</span> 递增字段的类型，numeric 表示数值类型, timestamp 表示时间戳类型
<span class="hljs-symbol">tracking_column:</span> 递增字段的名称，这里使用 update_time 这一列，这列的类型是 timestamp
<span class="hljs-symbol">last_run_metadata_path:</span> 同步点文件，这个文件记录了上次的同步点，重启时会读取这个文件，这个文件可以手动修改</code></pre></div>

<div class="hljs"><pre><code class="hljs pgsql">logstash-<span class="hljs-keyword">input</span>-jdbc原理:

使用 logstash-<span class="hljs-keyword">input</span>-jdbc 插件读取 mysql 的数据，这个插件的工作原理比较简单，就是定时执行一个 <span class="hljs-keyword">sql</span>，然后将 <span class="hljs-keyword">sql</span> 执行的结果写入到流中，增量获取的方式没有通过 binlog 方式同步，而是用一个递增字段作为条件去查询，每次都记录当前查询的位置，由于递增的特性，只需要查询比当前大的记录即可获取这段时间内的全部增量，一般的递增字段有两种，AUTO_INCREMENT 的主键 id 和 <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> 的 update_time 字段，id 字段只适用于那种只有插入没有更新的表，update_time 更加通用一些，建议在 mysql 表设计的时候都增加一个 update_time 字段</code></pre></div>

<h3 id="4-3-4-docker-compose配置文件"><a href="#4-3-4-docker-compose配置文件" class="headerlink" title="4.3.4 docker-compose配置文件"></a>4.3.4 docker-compose配置文件</h3><p>编辑docker-compose配置文件logstash.yml</p>
<div class="hljs"><pre><code class="hljs less"><span class="hljs-attribute">version</span>: <span class="hljs-string">'3'</span>
<span class="hljs-attribute">services</span>:
  <span class="hljs-attribute">logstash</span>:
    <span class="hljs-attribute">image</span>: logstash
    <span class="hljs-attribute">container_name</span>: logstash
    <span class="hljs-attribute">restart</span>: always
    <span class="hljs-attribute">networks</span>:
      <span class="hljs-attribute">default</span>:
        <span class="hljs-attribute">ipv4_address</span>: <span class="hljs-number">172.30</span>.<span class="hljs-number">0.4</span>
    <span class="hljs-attribute">ports</span>:
      - <span class="hljs-number">5044</span>:<span class="hljs-number">5044</span>
      - <span class="hljs-number">4560</span>:<span class="hljs-number">4560</span>
      - <span class="hljs-number">8080</span>:<span class="hljs-number">8080</span>
    <span class="hljs-attribute">volumes</span>:
      - ./<span class="hljs-attribute">data</span>:/data
      - ./<span class="hljs-attribute">config</span>:/config
      - ./<span class="hljs-attribute">patterns</span>:/opt/logstash/patterns
      - ./logs/tomcat.<span class="hljs-attribute">logs</span>:/logs/tomcat.logs
      - ./java/mysql-connector-java-<span class="hljs-number">5.1</span>.<span class="hljs-number">46</span>.<span class="hljs-attribute">jar</span>:/mysql-connector-java-<span class="hljs-number">5.1</span>.<span class="hljs-number">46</span>.jar
    <span class="hljs-attribute">external_links</span>:
      - <span class="hljs-attribute">elasticsearch</span>:elasticsearch
    <span class="hljs-attribute">command</span>: bash -c <span class="hljs-string">"chmod +x /data &amp;&amp; logstash -f /config/mysql_tables.conf --path.data=/data"</span>

<span class="hljs-attribute">networks</span>:
  <span class="hljs-attribute">default</span>:
    <span class="hljs-attribute">external</span>:
      <span class="hljs-attribute">name</span>: elk-network</code></pre></div>

<p><strong>注意事项：</strong></p>
<ul>
<li><p>logstash -f /config/ 会启动config文件夹下全部需要同步数据来源的配置文件，但是需要在input中指定type进行不同来源的区分，在output进行区分输出</p>
</li>
<li><p>logstash -f /config/mysql_tables.conf 指定启动某个数据来源的配置文件</p>
</li>
</ul>
<h3 id="4-3-5-构建脚本"><a href="#4-3-5-构建脚本" class="headerlink" title="4.3.5 构建脚本"></a>4.3.5 构建脚本</h3><p>编辑构建脚本build.sh</p>
<div class="hljs"><pre><code class="hljs css"><span class="hljs-selector-tag">docker-compose</span> <span class="hljs-selector-tag">-f</span> <span class="hljs-selector-tag">logstash</span><span class="hljs-selector-class">.yml</span> <span class="hljs-selector-tag">stop</span>

<span class="hljs-selector-tag">docker-compose</span> <span class="hljs-selector-tag">-f</span> <span class="hljs-selector-tag">logstash</span><span class="hljs-selector-class">.yml</span> <span class="hljs-selector-tag">rm</span> <span class="hljs-selector-tag">--force</span>

<span class="hljs-selector-tag">docker-compose</span> <span class="hljs-selector-tag">-f</span> <span class="hljs-selector-tag">logstash</span><span class="hljs-selector-class">.yml</span> <span class="hljs-selector-tag">up</span> <span class="hljs-selector-tag">-d</span></code></pre></div>

<p>执行构建脚本</p>
<div class="hljs"><pre><code class="hljs n1ql">$ chmod +x <span class="hljs-keyword">build</span>.sh &amp;&amp; ./<span class="hljs-keyword">build</span>.sh</code></pre></div>

<p>查看启动日志，发现数据库两个表数据已经成功同步,每当数据库指定表中插入数据时，数据会在设定的同步时间内同步到elasticsearch中。目前设置的同步策略为一分钟同步一次</p>
<p><img src="http://image.focusprogram.top/20200511125914.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt=""></p>
<h2 id="4-4-kibana"><a href="#4-4-kibana" class="headerlink" title="4.4 kibana"></a>4.4 kibana</h2><blockquote>
<p>Kibana 是一款开源的数据分析和可视化平台，它是 Elastic Stack 成员之一，设计用于和 Elasticsearch 协作。您可以使用 Kibana 对 Elasticsearch 索引中的数据进行搜索、查看、交互操作。您可以很方便的利用图表、表格及地图对数据进行多元化的分析和呈现。</p>
<p>Kibana 可以使大数据通俗易懂。它很简单，基于浏览器的界面便于您快速创建和分享动态数据仪表板来追踪 Elasticsearch 的实时数据变化。</p>
</blockquote>
<h3 id="4-4-1-docker-compose配置文件"><a href="#4-4-1-docker-compose配置文件" class="headerlink" title="4.4.1 docker-compose配置文件"></a>4.4.1 docker-compose配置文件</h3><p>编辑kibana.yml配置文件</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">kibana:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">kibana</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">kibana</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-attr">default:</span>
        <span class="hljs-attr">ipv4_address:</span> <span class="hljs-number">172.30</span><span class="hljs-number">.0</span><span class="hljs-number">.5</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">ELASTICSEARCH_URL=http://172.30.0.2:9200</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">5601</span><span class="hljs-string">:5601</span>
    <span class="hljs-attr">external_links:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">elasticsearch:elasticsearch</span>

<span class="hljs-attr">networks:</span>
  <span class="hljs-attr">default:</span>
    <span class="hljs-attr">external:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">elk-network</span></code></pre></div>

<h3 id="4-4-2-构建脚本"><a href="#4-4-2-构建脚本" class="headerlink" title="4.4.2 构建脚本"></a>4.4.2 构建脚本</h3><div class="hljs"><pre><code class="hljs css"><span class="hljs-selector-tag">docker-compose</span> <span class="hljs-selector-tag">-f</span> <span class="hljs-selector-tag">kibana</span><span class="hljs-selector-class">.yml</span> <span class="hljs-selector-tag">stop</span>

<span class="hljs-selector-tag">docker-compose</span> <span class="hljs-selector-tag">-f</span> <span class="hljs-selector-tag">kibana</span><span class="hljs-selector-class">.yml</span> <span class="hljs-selector-tag">rm</span> <span class="hljs-selector-tag">--force</span>

<span class="hljs-selector-tag">docker-compose</span> <span class="hljs-selector-tag">-f</span> <span class="hljs-selector-tag">kibana</span><span class="hljs-selector-class">.yml</span> <span class="hljs-selector-tag">up</span> <span class="hljs-selector-tag">-d</span></code></pre></div>

<p>执行构建脚本</p>
<div class="hljs"><pre><code class="hljs n1ql">$ chmod +x <span class="hljs-keyword">build</span>.sh &amp;&amp; ./<span class="hljs-keyword">build</span>.sh</code></pre></div>

<p>成功构建，显示如下：</p>
<p><img src="http://image.focusprogram.top/20200511130308.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt=""></p>
<h3 id="4-4-3-访问Kibana"><a href="#4-4-3-访问Kibana" class="headerlink" title="4.4.3 访问Kibana"></a>4.4.3 访问Kibana</h3><p><a href="http://192.168.80.130:5601/status" target="_blank" rel="noopener">http://192.168.80.130:5601/status</a></p>
<p><img src="http://image.focusprogram.top/20200511133846.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt=""></p>
<p><a href="http://192.168.80.130:5601/" target="_blank" rel="noopener">http://192.168.80.130:5601/</a></p>
<p><img src="http://image.focusprogram.top/20200511130538.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt=""></p>
<p>创建索引user、product</p>
<p><img src="http://image.focusprogram.top/20200511132114.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt=""></p>
<p><img src="http://image.focusprogram.top/20200511132218.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt=""></p>

            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/k-focusprogram.gitee.io/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/k-focusprogram.gitee.io/tags/SpringCloud/">SpringCloud</a>
                    
                      <a class="hover-with-bg" href="/k-focusprogram.gitee.io/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/k-focusprogram.gitee.io/2020/07/11/ELK-Kafka%E5%88%86%E5%B8%83%E5%BC%8F%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ELK-Kafka分布式日志收集</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/k-focusprogram.gitee.io/2020/07/11/xxl-job/">
                        <span class="hidden-mobile">xxl-job</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
              <!-- Comments -->
              <div class="comments" id="comments">
                
                
  <div id="vcomments"></div>
  <script type="text/javascript">
    function loadValine() {
      addScript('https://cdn.staticfile.org/valine/1.4.14/Valine.min.js', function () {
        new Valine({
          el: "#vcomments",
          app_id: "XjjXuhrzyfTeHFAzz4XEQWeA-gzGzoHsz",
          app_key: "VOV2U2qRAhtqyuBiioUEvrNV",
          placeholder: "留下您想说的话吧(*^▽^*)",
          path: window.location.pathname,
          avatar: "wavatar",
          meta: ["nick","mail"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: true,
          recordIP: true,
          serverURLs: "",
        });
      });
    }
    createObserver(loadValine, 'vcomments');
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://valine.js.org" target="_blank" rel="nofollow noopener noopener">comments
      powered by Valine.</a></noscript>


              </div>
            
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!--
<script src="https://utteranc.es/client.js"
        repo="FocusProgram/focusprogram.github.io"
        issue-term="title"
        label="utterances"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
-->


<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
<div id="dark-div">
  <a id="dark" onclick="switchDarkMode()"></a>
</div>
<script>
  var isNight = new Date().getHours() >= 22 || new Date().getHours() < 7;
  if( matchMedia('(prefers-color-scheme: dark)').matches || isNight || localStorage.getItem('dark') === '1') {
    if(!(isNight&&localStorage.getItem('noDark') === '1')) {
      document.body.classList.add('dark');
    }
  }
  document.getElementById('dark').innerHTML = document.querySelector("body").classList.contains("dark")?"🌙":"🌞";
</script>
  <div class="text-center py-3">
    <div>
      <a rel="nofollow noopener"><span>永远执着&nbsp;&nbsp;</span></a>
      <i class="iconfont icon-love"></i>
      <a rel="nofollow noopener">
        <span>&nbsp;&nbsp;永远热爱</span></a>
    </div>
    
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


    
  <!-- 备案信息 -->
  <div class="beian">
    <img src="https://image.focusprogram.top/icp_beian.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" style="margin-top:-5px">
    <a href="http://beian.miit.gov.cn/" target="_blank"
       rel="nofollow noopener">苏ICP备19063834号-1</a>
    
      <a
        href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44030602004695"
        rel="nofollow noopener"
        class="beian-police"
        target="_blank"
      >
        <span class="beian-police-sep">&nbsp;|&nbsp;</span>
        
          <img src="/k-focusprogram.gitee.io/img/police_beian.png" srcset="/k-focusprogram.gitee.io/img/loading.gif" alt="police-icon" />
        
        <span>苏公安网备44030602004695号</span>
      </a>
     
  </div>


    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/k-focusprogram.gitee.io/js/debouncer.js" ></script>
<script  src="/k-focusprogram.gitee.io/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/k-focusprogram.gitee.io/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/k-focusprogram.gitee.io/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: 'article.markdown-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "ELK详解&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/k-focusprogram.gitee.io/js/local-search.js" ></script>
  <script>
    var path = "/k-focusprogram.gitee.io/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>









  <script>(function (i, s, o, g, r, a, m) {
      i['DaoVoiceObject'] = r;
      i[r] = i[r] ||
        function () {
          (i[r].q = i[r].q || []).push(arguments);
        };
      i[r].l = 1 * new Date();
      a = s.createElement(o);
      m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      a.charset = 'utf-8';
      m.parentNode.insertBefore(a, m);
    })(window, document, 'script', ('https:' === document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/98eb4efd.js", 'daovoice');
    daovoice('init', {
      app_id: "98eb4efd",
    });
    daovoice('update');
  </script>









  

  

  

  

  

  




</body>
</html>